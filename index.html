<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ArquiPlan - Editor de Planos</title>
<style>
:root {
  --bg0:#0b0b14;--bg1:#12121e;--bg2:#1a1a2e;--bg3:#222240;--bg4:#2a2a4a;
  --brd:#2d2d50;--brd2:#3a3a60;--txt:#dde;--txt2:#99a;--txt3:#667;
  --acc:#5b8def;--acc2:#7ba4ff;--accg:#5b8def30;--grn:#3dd6a0;--ylw:#ffd166;
  --red:#ef476f;--pink:#ff8fab;--org:#f4845f;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',sans-serif;overflow:hidden;height:100vh;display:flex;flex-direction:column;background:var(--bg0);color:var(--txt);-webkit-font-smoothing:antialiased}

/* TOPBAR */
#topbar{display:flex;align-items:center;gap:6px;padding:0 10px;background:linear-gradient(180deg,var(--bg3),var(--bg2));border-bottom:1px solid var(--brd);height:44px;flex-shrink:0;z-index:10}
.logo{font-size:14px;font-weight:800;color:var(--acc);letter-spacing:-.5px;margin-right:6px;user-select:none}
.logo span{color:var(--txt3);font-weight:400;font-size:11px}
.sep{width:1px;height:22px;background:var(--brd);margin:0 2px;flex-shrink:0}
.tg{display:flex;align-items:center;gap:3px}
.tb{padding:5px 10px;background:var(--bg4);border:1px solid var(--brd);border-radius:5px;color:var(--txt2);cursor:pointer;font-size:11px;font-weight:500;transition:all .12s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.tb:hover{background:var(--brd);color:var(--txt)}
.tb:active{transform:scale(.97)}
.tb.pr{background:var(--acc);color:#fff;border-color:var(--acc)}
.tb.pr:hover{background:var(--acc2)}
.tb svg{width:13px;height:13px;flex-shrink:0}
.tl{font-size:10px;color:var(--txt3);white-space:nowrap}
.ti{width:56px;padding:3px 5px;background:var(--bg0);border:1px solid var(--brd);border-radius:4px;color:var(--acc2);font-size:11px;font-weight:600;text-align:center}
.ti:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 2px var(--accg)}
.zd{font-size:11px;color:var(--acc);font-weight:700;min-width:40px;text-align:center;background:var(--bg0);border:1px solid var(--brd);border-radius:4px;padding:3px 6px}
.tck{display:flex;align-items:center;gap:4px;cursor:pointer;font-size:10px;color:var(--txt2);user-select:none;padding:3px 6px;border-radius:4px}
.tck:hover{background:var(--bg4)}
.tck input{display:none}
.tck .ck{width:12px;height:12px;border:1.5px solid var(--brd2);border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tck input:checked+.ck{background:var(--acc);border-color:var(--acc)}
.tck input:checked+.ck::after{content:'';width:3px;height:6px;border:solid #fff;border-width:0 1.5px 1.5px 0;transform:rotate(45deg) translate(-0.5px,-0.5px)}

/* PROJECT INDICATOR */
#projind{display:none;align-items:center;gap:5px;padding:0 8px;font-size:11px;color:var(--txt);white-space:nowrap;max-width:180px}
.pi-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pi-dot.saved{background:var(--grn)}
.pi-dot.dirty{background:var(--ylw)}
.pi-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
/* SAVE DROPDOWN */
.save-wrap{position:relative}
.save-dd{display:none;position:absolute;top:100%;left:0;margin-top:4px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.45);z-index:50;min-width:190px;padding:4px;animation:mi .1s ease-out}
.save-dd.vis{display:block}
.save-dd button{display:flex;align-items:center;gap:6px;width:100%;padding:7px 10px;border:none;background:none;color:var(--txt2);font-size:11px;cursor:pointer;border-radius:5px;text-align:left;white-space:nowrap}
.save-dd button:hover{background:var(--bg4);color:var(--txt)}
.save-dd button svg{width:14px;height:14px;flex-shrink:0}
.save-dd .sdd-sep{height:1px;background:var(--brd);margin:3px 4px}

/* MAIN */
#main{display:flex;flex:1;min-height:0}

/* TOOLBAR */
#tools{width:50px;background:var(--bg2);border-right:1px solid var(--brd);display:flex;flex-direction:column;padding:6px;gap:2px;flex-shrink:0;position:relative;z-index:8}
.tbn{width:38px;height:36px;display:flex;align-items:center;justify-content:center;border:none;border-radius:6px;background:none;cursor:pointer;color:var(--txt2);position:relative;transition:all .12s}
.tbn svg{width:18px;height:18px}
.tbn:hover{background:var(--bg4);color:var(--txt)}
.tbn.on{background:linear-gradient(135deg,var(--acc),#4a70d0);color:#fff;box-shadow:0 2px 10px var(--accg)}
.tbn .tp{display:none;position:absolute;left:46px;top:50%;transform:translateY(-50%);background:var(--bg0);color:var(--txt);padding:5px 8px;border-radius:5px;font-size:11px;white-space:nowrap;z-index:100;border:1px solid var(--brd);box-shadow:0 4px 12px rgba(0,0,0,.5);pointer-events:none}
.tbn .tp b{background:var(--bg4);color:var(--txt3);padding:1px 4px;border-radius:2px;font-size:9px;margin-left:5px;font-weight:600}
.tbn:hover .tp{display:block}
.tsp{height:1px;background:var(--brd);margin:3px 0}

/* CANVAS */
#canvas{flex:1;position:relative;overflow:hidden;background:var(--bg0);background-image:radial-gradient(#151528 0%,var(--bg0) 70%)}
#canvas.pan{cursor:grab}
#canvas.panning{cursor:grabbing}
#canvas.draw{cursor:crosshair}
#canvas.erase{cursor:not-allowed}
#svgwrap{position:absolute;transform-origin:0 0}

/* SVG elements */
.room-block{cursor:pointer}
.room-block:hover .room-rect{stroke-width:5;stroke:var(--acc)}
.room-rect{transition:stroke .1s,stroke-width .1s}
.room-label{pointer-events:none;user-select:none}
.room-sub{pointer-events:none;user-select:none}
.room-dims{pointer-events:none;user-select:none}
.furn-block{cursor:pointer}
.furn-block:hover rect:first-child{stroke:var(--acc);stroke-width:2}
.furn-detail{pointer-events:none}
.win-block{cursor:pointer}
.win-block:hover line{stroke:var(--acc)}
.win-block:hover rect:first-child{stroke:var(--acc);stroke-width:1}
.door-block{cursor:pointer}
.door-block:hover line{stroke:var(--acc)}
.door-block:hover path{stroke:var(--acc)}
.wall-block{cursor:pointer}
.wall-block:hover rect:first-child{stroke:var(--acc);stroke-width:2.5}
.sel-box{fill:none;stroke:var(--acc);stroke-width:1.5;stroke-dasharray:5,3;pointer-events:none}
.sel-fill{fill:var(--accg);stroke:none;pointer-events:none}
.sel-h{fill:#fff;stroke:var(--acc);stroke-width:2;rx:2;cursor:pointer;pointer-events:all}
.snap-h{stroke:var(--grn);stroke-width:1;stroke-dasharray:4,3;pointer-events:none}
.snap-v{stroke:var(--grn);stroke-width:1;stroke-dasharray:4,3;pointer-events:none}
.dim-g line.dl{stroke:var(--pink);stroke-width:1.5}
.dim-g line.de{stroke:var(--pink);stroke-width:.8;opacity:.5}
.dim-g text{fill:var(--pink);font-size:12px;font-weight:700;text-anchor:middle;font-family:Inter,Arial,sans-serif}
.dim-g rect.dbg{fill:#f8f6f1;rx:3}
.room-tile{pointer-events:none;opacity:.6}
select.pin{padding:5px 7px;background:var(--bg0);border:1px solid var(--brd);border-radius:4px;color:var(--txt);font-size:11px;width:100%}
.room-poly{transition:stroke .1s,stroke-width .1s}
.room-block:hover .room-poly{stroke-width:5;stroke:var(--acc)}
.live-t{fill:var(--ylw);font-size:13px;font-weight:700;text-anchor:middle;pointer-events:none;font-family:Inter,Arial,sans-serif}
.grid-maj{stroke:#1e1e3a;stroke-width:.8}
.grid-min{stroke:#15152a;stroke-width:.4}
.grid-lbl{fill:#444;font-size:8px;font-family:Inter,Arial,sans-serif}

/* LASSO */
.lasso-rect{fill:rgba(91,141,239,.1);stroke:var(--acc);stroke-width:1;stroke-dasharray:5,3;pointer-events:none}

/* ROTATION HANDLE */
.rot-h{fill:var(--acc2);stroke:#fff;stroke-width:1.5;cursor:grab;pointer-events:all}
.rot-h:hover{fill:var(--ylw)}
.rot-line{stroke:var(--acc);stroke-width:1;stroke-dasharray:3,2;pointer-events:none}

/* SELECTION ACTION BAR */

/* RIGHT PANEL */
#rpanel{width:250px;background:var(--bg2);border-left:1px solid var(--brd);display:flex;flex-direction:column;flex-shrink:0;z-index:5;overflow-y:auto}
.psec{padding:12px;border-bottom:1px solid var(--brd)}
.psh{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.psh h3{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--txt3)}
.psh .badge{font-size:9px;background:var(--acc);color:#fff;padding:1px 6px;border-radius:8px;font-weight:600}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.pi{display:flex;flex-direction:column;gap:2px}
.pi.f{grid-column:1/-1}
.pl{font-size:9px;color:var(--txt3);font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.pv{font-size:12px;color:var(--acc2);font-weight:700;background:var(--bg0);padding:5px 7px;border-radius:4px;border:1px solid var(--brd)}
.pin{padding:5px 7px;background:var(--bg0);border:1px solid var(--brd);border-radius:4px;color:var(--txt);font-size:11px;width:100%}
.pin:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 2px var(--accg)}
.pcr{display:flex;align-items:center;gap:6px}
.pcs{width:24px;height:24px;border-radius:5px;border:2px solid var(--brd);cursor:pointer;flex-shrink:0;position:relative;overflow:hidden}
.pcs input{position:absolute;inset:-4px;width:32px;height:32px;opacity:0;cursor:pointer}

/* Library */
.lg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.li{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 3px;background:var(--bg4);border:1px solid var(--brd);border-radius:6px;cursor:grab;transition:all .12s;user-select:none}
.li:hover{border-color:var(--acc);background:var(--bg3);transform:translateY(-1px)}
.li:active{transform:scale(.96);cursor:grabbing}
.li svg{width:24px;height:24px;color:var(--txt2)}
.li:hover svg{color:var(--acc)}
.li span{font-size:9px;color:var(--txt3);font-weight:500}
.cat-hdr{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 4px;cursor:pointer;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--txt3);user-select:none;border-bottom:1px solid var(--brd)}
.cat-hdr:hover{color:var(--txt)}
.cat-hdr svg{width:12px;height:12px;transition:transform .15s}
.cat-hdr.cat-closed svg{transform:rotate(-90deg)}
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:4px 0}
.cat-grid.cat-hide{display:none}
.layer-row{padding:2px 0}
.qc{display:flex;gap:4px;flex-wrap:wrap}
.qcd{width:20px;height:20px;border-radius:4px;border:2px solid var(--brd);cursor:pointer;transition:transform .1s}
.qcd:hover{transform:scale(1.25);z-index:1}

/* STATUS */
#sbar{height:24px;background:var(--bg2);border-top:1px solid var(--brd);display:flex;align-items:center;padding:0 12px;font-size:10px;color:var(--txt3);gap:16px;flex-shrink:0;z-index:10}
#sbar .sp{color:var(--grn);font-weight:600;font-family:'SF Mono','Fira Code',monospace;font-size:10px}

/* CTX MENU */
#ctx{display:none;position:fixed;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;padding:4px 0;min-width:180px;z-index:1000;box-shadow:0 8px 30px rgba(0,0,0,.5)}
#ctx.vis{display:block;animation:ci .1s ease-out}
@keyframes ci{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.ci{padding:6px 14px;font-size:12px;cursor:pointer;color:var(--txt);display:flex;align-items:center;gap:8px}
.ci:hover{background:var(--acc);color:#fff}
.ci .sk{margin-left:auto;font-size:10px;color:var(--txt3)}
.ci:hover .sk{color:rgba(255,255,255,.6)}
.csp{height:1px;background:var(--brd);margin:3px 6px}

/* MODAL */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.mo.vis{display:flex}
.mod{background:var(--bg3);border:1px solid var(--brd);border-radius:12px;padding:20px;min-width:320px;box-shadow:0 8px 30px rgba(0,0,0,.5);animation:mi .15s ease-out}
@keyframes mi{from{transform:scale(.93) translateY(8px);opacity:0}to{transform:none;opacity:1}}
.mod h3{font-size:15px;margin-bottom:12px}
.mod input[type=text]{width:100%;padding:8px 12px;background:var(--bg0);border:1px solid var(--brd);border-radius:6px;color:var(--txt);font-size:13px;margin-bottom:12px}
.mod input[type=text]:focus{outline:none;border-color:var(--acc)}
.moa{display:flex;gap:6px;justify-content:flex-end}
.mob{padding:7px 16px;border:1px solid var(--brd);border-radius:6px;background:var(--bg4);color:var(--txt);cursor:pointer;font-size:12px}
.mob:hover{background:var(--brd)}
.mob.pr{background:var(--acc);color:#fff;border-color:var(--acc)}

/* TOAST */
#toasts{position:fixed;bottom:36px;left:50%;transform:translateX(-50%);z-index:3000;display:flex;flex-direction:column;gap:6px;align-items:center}
.toast{padding:8px 18px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:12px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,.4);animation:ti .2s ease-out;display:flex;align-items:center;gap:6px}
.toast.ok::before,.toast.w::before{content:'';width:6px;height:6px;border-radius:50%;flex-shrink:0}
.toast.ok{border-color:var(--grn)}.toast.ok::before{background:var(--grn)}
.toast.w{border-color:var(--ylw)}.toast.w::before{background:var(--ylw)}
@keyframes ti{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* INLINE EDIT */
.inline-edit{position:fixed;text-align:center;background:rgba(0,0,0,.85);color:#fff;border:2px solid var(--acc);border-radius:4px;outline:none;padding:3px 6px;font-family:Inter,Arial,sans-serif;font-weight:600;z-index:5000}

/* LIGHT MODE */
body.light{--bg0:#f5f5f5;--bg1:#fafafa;--bg2:#fff;--bg3:#f0f0f0;--bg4:#e8e8e8;
  --brd:#ddd;--brd2:#ccc;--txt:#333;--txt2:#666;--txt3:#999;
  --acc:#3a7bf7;--acc2:#2563eb;--accg:rgba(58,123,247,.15);--grn:#10b981;--ylw:#f59e0b;
  --red:#ef4444;--pink:#ec4899;--org:#f97316}
body.light #canvas{background:#e8e8e8;background-image:radial-gradient(#ddd 0%,#e8e8e8 70%)}
body.light .inline-edit{background:rgba(255,255,255,.95);color:#333;border-color:var(--acc)}
body.light .tbn.on{box-shadow:0 2px 8px rgba(58,123,247,.25)}
body.light .toast{box-shadow:0 4px 16px rgba(0,0,0,.12)}
body.light #ctx{box-shadow:0 8px 30px rgba(0,0,0,.15)}

/* RULERS */
.ruler{position:absolute;background:var(--bg2);overflow:hidden;z-index:6}
.ruler canvas{display:block}
#rulerH{top:0;left:22px;right:0;height:22px;border-bottom:1px solid var(--brd)}
#rulerV{top:22px;left:0;bottom:0;width:22px;border-right:1px solid var(--brd)}
#rulerC{position:absolute;top:0;left:0;width:22px;height:22px;background:var(--bg3);border-right:1px solid var(--brd);border-bottom:1px solid var(--brd);z-index:7;display:flex;align-items:center;justify-content:center;font-size:7px;color:var(--txt3)}

/* ALIGN BUTTONS */
.align-row{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px}
.abtn{width:28px;height:26px;display:flex;align-items:center;justify-content:center;border:1px solid var(--brd);border-radius:4px;background:var(--bg4);cursor:pointer;color:var(--txt2);transition:all .12s;padding:0}
.abtn:hover{background:var(--brd);color:var(--txt)}
.abtn svg{width:14px;height:14px}

/* BG IMAGE */
.bg-ctrl{display:flex;align-items:center;gap:6px;padding:3px 0}
.bg-ctrl input[type=range]{flex:1;height:4px;accent-color:var(--acc);cursor:pointer}
.bg-ctrl span{font-size:9px;color:var(--txt3);min-width:28px;text-align:right}

/* PROJECTS MODAL */
.proj-list{max-height:260px;overflow-y:auto;margin-bottom:10px}
.proj-item{display:flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid transparent;border-radius:6px;cursor:pointer;font-size:12px;color:var(--txt);transition:all .1s;margin-bottom:2px}
.proj-item:hover{background:var(--bg4);border-color:var(--brd)}
.proj-item.active{background:var(--accg);border-color:var(--acc)}
.proj-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.proj-date{font-size:9px;color:var(--txt3);white-space:nowrap}
.proj-dl{width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:none;background:none;color:var(--txt3);cursor:pointer;border-radius:3px;font-size:14px;line-height:1;flex-shrink:0}
.proj-dl:hover{background:var(--acc);color:#fff}
.proj-del{width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:none;background:none;color:var(--txt3);cursor:pointer;border-radius:3px;font-size:14px;line-height:1;flex-shrink:0}
.proj-del:hover{background:var(--red);color:#fff}

/* WIZARD */
.wiz-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.wiz-card{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 8px;background:var(--bg4);border:2px solid var(--brd);border-radius:10px;cursor:pointer;transition:all .15s;user-select:none}
.wiz-card:hover{border-color:var(--acc);background:var(--bg3);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.wiz-card:active{transform:scale(.97)}
.wiz-card svg{border-radius:4px;background:var(--bg0);border:1px solid var(--brd)}
.wiz-card h4{font-size:11px;font-weight:700;color:var(--txt);margin:0;text-align:center}
.wiz-card .wiz-info{font-size:9px;color:var(--txt3);text-align:center}
.wiz-sep{display:flex;align-items:center;gap:8px;margin:6px 0 10px;font-size:10px;color:var(--txt3);text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.wiz-sep::before,.wiz-sep::after{content:'';flex:1;height:1px;background:var(--brd)}
.wiz-custom{display:flex;align-items:flex-end;gap:8px}
.wiz-custom .wiz-field{display:flex;flex-direction:column;gap:3px}
.wiz-custom .wiz-field label{font-size:9px;color:var(--txt3);font-weight:600;text-transform:uppercase}
.wiz-custom .wiz-field input{width:70px;padding:6px 8px;background:var(--bg0);border:1px solid var(--brd);border-radius:5px;color:var(--txt);font-size:12px;font-weight:600;text-align:center}
.wiz-custom .wiz-field input:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 2px var(--accg)}

/* HELP MODAL */
.help-body{max-height:65vh;overflow-y:auto;padding-right:4px}
.help-body::-webkit-scrollbar{width:5px}
.help-body::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:3px}
.help-intro{background:linear-gradient(135deg,var(--accg),rgba(61,214,160,.1));border:1px solid var(--acc);border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:12px;line-height:1.6;color:var(--txt)}
.help-intro b{color:var(--acc)}
.help-sec{border:1px solid var(--brd);border-radius:8px;margin-bottom:6px;overflow:hidden}
.help-hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;user-select:none;font-size:12px;font-weight:700;color:var(--txt);transition:background .1s}
.help-hdr:hover{background:var(--bg4)}
.help-hdr svg{width:16px;height:16px;color:var(--acc);flex-shrink:0}
.help-hdr span{flex:1}
.help-hdr .chevron{width:12px;height:12px;color:var(--txt3);transition:transform .15s;flex-shrink:0}
.help-sec.open .help-hdr .chevron{transform:rotate(90deg)}
.help-cnt{display:none;padding:0 12px 12px;font-size:11px;line-height:1.65;color:var(--txt2)}
.help-sec.open .help-cnt{display:block}
.help-step{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
.help-num{width:24px;height:24px;background:var(--acc);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.help-stxt{flex:1}
.help-stxt b{color:var(--txt)}
.help-tbl{width:100%;border-collapse:collapse;margin:6px 0}
.help-tbl th{text-align:left;font-size:10px;color:var(--txt3);font-weight:600;padding:4px 8px;border-bottom:1px solid var(--brd);text-transform:uppercase;letter-spacing:.4px}
.help-tbl td{padding:5px 8px;border-bottom:1px solid var(--brd);font-size:11px}
.help-tbl td:first-child{font-weight:600;color:var(--txt);white-space:nowrap}
.help-tbl tr:last-child td{border-bottom:none}
.help-kbd{display:inline-block;background:var(--bg0);border:1px solid var(--brd);border-radius:3px;padding:1px 5px;font-size:10px;font-weight:600;color:var(--txt);font-family:'SF Mono','Fira Code',monospace;line-height:1.4}
.help-tip{background:var(--bg4);border-left:3px solid var(--ylw);border-radius:0 6px 6px 0;padding:8px 10px;margin:8px 0;font-size:11px;color:var(--txt2)}
.help-tip b{color:var(--ylw)}
</style>
</head>
<body>

<div id="topbar">
  <div class="logo">ArquiPlan <span>v1.0</span></div>
  <div class="sep"></div>
  <div class="tg">
    <button class="tb" onclick="showWizard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Nuevo</button>
    <button class="tb" onclick="showProjectsModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>Abrir</button>
    <div class="save-wrap">
      <button class="tb" onclick="toggleSaveDD()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Guardar<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px;margin-left:-2px"><polyline points="6 9 12 15 18 9"/></svg></button>
      <div class="save-dd" id="savedd">
        <button onclick="saveProject();closeSaveDD()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>Guardar (Ctrl+S)</button>
        <button onclick="showSaveAsModal();closeSaveDD()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>Guardar como...</button>
        <div class="sdd-sep"></div>
        <button onclick="exportProjectFile();closeSaveDD()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Exportar archivo .json</button>
        <button onclick="$('projinput').click();closeSaveDD()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Importar archivo .json</button>
      </div>
    </div>
  </div>
  <div id="projind"></div>
  <div class="sep"></div>
  <div class="tg">
    <button class="tb pr" onclick="expSVG()">SVG</button>
    <button class="tb" onclick="expPNG()">PNG</button>
    <button class="tb" onclick="expPDF()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>PDF</button>
  </div>
  <div class="sep"></div>
  <div class="tg">
    <span class="tl">Ancho:</span><input class="ti" id="sw" type="number" value="8.50" step=".1" min=".1" onchange="updScale()"><span class="tl">m</span>
    <span class="tl" style="margin-left:3px">Alto:</span><input class="ti" id="sh" type="number" value="10.10" step=".1" min=".1" onchange="updScale()"><span class="tl">m</span>
  </div>
  <div class="sep"></div>
  <div class="tg">
    <button class="tb" onclick="zout()" style="padding:5px 7px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    <span class="zd" id="zlbl">100%</span>
    <button class="tb" onclick="zin()" style="padding:5px 7px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
    <button class="tb" onclick="fit()">Ajustar</button>
  </div>
  <div class="sep"></div>
  <label class="tck"><input type="checkbox" id="gridck" onchange="togGrid()"><span class="ck"></span>Grilla</label>
  <label class="tck"><input type="checkbox" id="snapck" checked><span class="ck"></span>Snap</label>
  <label class="tck"><input type="checkbox" id="dimck" checked onchange="togDims()"><span class="ck"></span>Cotas</label>
  <label class="tck"><input type="checkbox" id="scaleck" checked onchange="togScale()"><span class="ck"></span>Escala</label>
  <label class="tck"><input type="checkbox" id="rulerck" checked onchange="togRulers()"><span class="ck"></span>Reglas</label>
  <div class="sep"></div>
  <button class="tb" onclick="importBgImage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Fondo</button>
  <div style="flex:1"></div>
  <button class="tb" onclick="showHelp()" title="Ayuda" style="padding:5px 7px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button>
  <button class="tb" onclick="toggleTheme()" id="themeBtn" title="Modo claro/oscuro" style="padding:5px 7px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button>
  <div class="tg">
    <button class="tb" onclick="undo()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg></button>
    <button class="tb" onclick="redo()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.13-9.36L23 10"/></svg></button>
  </div>
</div>

<div id="main">
  <div id="tools">
    <button class="tbn on" data-t="select" onclick="setT('select')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg><span class="tp">Seleccionar <b>V</b></span></button>
    <button class="tbn" data-t="pan" onclick="setT('pan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg><span class="tp">Mover vista <b>H</b></span></button>
    <div class="tsp"></div>
    <button class="tbn" data-t="room" onclick="setT('room')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="1"/></svg><span class="tp">Habitacion <b>R</b></span></button>
    <button class="tbn" data-t="wall" onclick="setT('wall')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="4" y1="4" x2="4" y2="20"/><line x1="4" y1="4" x2="20" y2="4"/><line x1="20" y1="4" x2="20" y2="20"/></svg><span class="tp">Pared <b>W</b></span></button>
    <button class="tbn" data-t="door" onclick="setT('door')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="3" width="12" height="18" rx="1"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/></svg><span class="tp">Puerta <b>D</b></span></button>
    <button class="tbn" data-t="window" onclick="setT('window')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="1"/><line x1="12" y1="6" x2="12" y2="18"/></svg><span class="tp">Ventana <b>N</b></span></button>
    <div class="tsp"></div>
    <button class="tbn" data-t="text" onclick="setT('text')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="4 7 4 4 20 4 20 7"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="8" y1="20" x2="16" y2="20"/></svg><span class="tp">Texto <b>T</b></span></button>
    <button class="tbn" data-t="dim" onclick="setT('dim')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="7 9 4 12 7 15"/><polyline points="17 9 20 12 17 15"/><line x1="4" y1="7" x2="4" y2="17"/><line x1="20" y1="7" x2="20" y2="17"/></svg><span class="tp">Cota <b>M</b></span></button>
    <div class="tsp"></div>
    <button class="tbn" data-t="eraser" onclick="setT('eraser')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l9-9 8 8-4 4"/><path d="M6.5 13.5l5 5"/></svg><span class="tp">Borrar <b>E</b></span></button>
  </div>

  <div id="canvas" oncontextmenu="return false">
    <div id="rulerC">m</div>
    <div class="ruler" id="rulerH"><canvas id="rHc"></canvas></div>
    <div class="ruler" id="rulerV"><canvas id="rVc"></canvas></div>
    <div id="svgwrap"></div>
  </div>

  <div id="rpanel">
    <div class="psec" id="propsec" style="display:none">
      <div class="psh"><h3 id="ptitle">Propiedades</h3><span class="badge" id="ptype"></span></div>
      <div id="pcontent"></div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap">
        <button class="abtn" onclick="rot90()" title="Rotar 90° (R)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
        <button class="abtn" onclick="flipH()" title="Voltear Horizontal (H)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20"/><polyline points="16 6 20 12 16 18"/><polyline points="8 6 4 12 8 18"/></svg></button>
        <button class="abtn" onclick="flipV()" title="Voltear Vertical (V)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20"/><polyline points="6 8 12 4 18 8"/><polyline points="6 16 12 20 18 16"/></svg></button>
        <div style="width:1px;height:20px;background:var(--brd);margin:0 2px"></div>
        <button class="abtn" onclick="dup()" title="Duplicar (Ctrl+D)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
        <button class="abtn" onclick="delSel()" title="Eliminar (Supr)" style="color:var(--red)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      </div>
    </div>
    <div class="psec" id="alignsec" style="display:none">
      <div class="psh"><h3>Alinear</h3></div>
      <div class="align-row">
        <button class="abtn" onclick="alignSel('left')" title="Alinear izquierda"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="2" x2="4" y2="22"/><rect x="7" y="4" width="13" height="5" rx="1"/><rect x="7" y="13" width="8" height="5" rx="1"/></svg></button>
        <button class="abtn" onclick="alignSel('centerH')" title="Centrar horizontal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><rect x="5" y="4" width="14" height="5" rx="1"/><rect x="7" y="13" width="10" height="5" rx="1"/></svg></button>
        <button class="abtn" onclick="alignSel('right')" title="Alinear derecha"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="20" y1="2" x2="20" y2="22"/><rect x="4" y="4" width="13" height="5" rx="1"/><rect x="9" y="13" width="8" height="5" rx="1"/></svg></button>
        <button class="abtn" onclick="alignSel('top')" title="Alinear arriba"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="4" x2="22" y2="4"/><rect x="4" y="7" width="5" height="13" rx="1"/><rect x="13" y="7" width="5" height="8" rx="1"/></svg></button>
        <button class="abtn" onclick="alignSel('centerV')" title="Centrar vertical"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/><rect x="4" y="5" width="5" height="14" rx="1"/><rect x="13" y="7" width="5" height="10" rx="1"/></svg></button>
        <button class="abtn" onclick="alignSel('bottom')" title="Alinear abajo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="20" x2="22" y2="20"/><rect x="4" y="4" width="5" height="13" rx="1"/><rect x="13" y="9" width="5" height="8" rx="1"/></svg></button>
      </div>
      <div class="align-row">
        <button class="abtn" onclick="alignSel('distH')" title="Distribuir horizontal" style="width:auto;padding:0 8px;font-size:9px;gap:3px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><line x1="4" y1="2" x2="4" y2="22"/><line x1="20" y1="2" x2="20" y2="22"/><rect x="9" y="6" width="6" height="12" rx="1"/></svg>Dist H</button>
        <button class="abtn" onclick="alignSel('distV')" title="Distribuir vertical" style="width:auto;padding:0 8px;font-size:9px;gap:3px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><line x1="2" y1="4" x2="22" y2="4"/><line x1="2" y1="20" x2="22" y2="20"/><rect x="6" y="9" width="12" height="6" rx="1"/></svg>Dist V</button>
      </div>
    </div>
    <div class="psec" id="bgsec">
      <div class="psh"><h3>Imagen de Fondo</h3></div>
      <div id="bgcontent">
        <div style="font-size:11px;color:var(--txt3);padding:4px 0">Sin imagen de fondo</div>
      </div>
    </div>
    <div class="psec" id="layersec">
      <div class="psh"><h3>Capas</h3></div>
      <div id="layercontent"></div>
    </div>
    <div class="psec" id="areasec">
      <div class="psh"><h3>Areas</h3></div>
      <div id="areacontent" style="max-height:220px;overflow-y:auto"></div>
    </div>
    <div class="psec">
      <div class="psh"><h3>Muebles</h3></div>
      <div id="furnlib"></div>
    </div>
    <div class="psec">
      <div class="psh"><h3>Colores</h3></div>
      <div class="qc" id="qcolors"></div>
    </div>
  </div>
</div>

<div id="sbar">
  <span class="sp" id="spos">X: 0.00m  Y: 0.00m</span>
  <span id="sinfo">Listo</span>
  <span style="margin-left:auto" id="sscale"></span>
</div>

<div id="ctx">
  <div class="ci" onclick="dup()">Duplicar <span class="sk">Ctrl+D</span></div>
  <div class="ci" onclick="rot90()">Rotar 90° <span class="sk">R</span></div>
  <div class="ci" onclick="flipH()">Voltear ↔ <span class="sk">H</span></div>
  <div class="ci" onclick="flipV()">Voltear ↕ <span class="sk">V</span></div>
  <div class="ci" onclick="front()">Al frente</div>
  <div class="ci" onclick="back()">Al fondo</div>
  <div class="csp"></div>
  <div class="ci" onclick="addDimsToSel()">Agregar cotas</div>
  <div class="csp"></div>
  <div class="ci" style="color:var(--red)" onclick="delSel()">Eliminar <span class="sk">Supr</span></div>
</div>

<div class="mo" id="modal">
  <div class="mod">
    <h3 id="mtitle">Nombre</h3>
    <input type="text" id="minput" autocomplete="off">
    <div class="moa">
      <button class="mob" onclick="modalNo()">Cancelar</button>
      <button class="mob pr" onclick="modalOk()">Aceptar</button>
    </div>
  </div>
</div>

<div class="mo" id="savemodal">
  <div class="mod" style="min-width:340px">
    <h3>Guardar proyecto</h3>
    <input type="text" id="savename" placeholder="Nombre del proyecto" autocomplete="off" onkeydown="if(event.key==='Enter'){event.preventDefault();doSaveAs()}">
    <div class="moa">
      <button class="mob" onclick="$('savemodal').classList.remove('vis')">Cancelar</button>
      <button class="mob pr" onclick="doSaveAs()">Guardar</button>
    </div>
  </div>
</div>

<div class="mo" id="projmodal">
  <div class="mod" style="min-width:380px">
    <h3>Proyectos</h3>
    <div id="projlist" class="proj-list"></div>
    <div class="moa">
      <button class="mob" onclick="$('projmodal').classList.remove('vis')">Cerrar</button>
      <button class="mob" onclick="$('projmodal').classList.remove('vis');$('projinput').click()">Importar .json</button>
      <button class="mob pr" onclick="$('projmodal').classList.remove('vis');showWizard()">Nuevo proyecto</button>
    </div>
  </div>
</div>

<div class="mo" id="wizmodal">
  <div class="mod" style="min-width:520px;max-width:560px">
    <h3 style="margin-bottom:4px">Nuevo Proyecto</h3>
    <p style="font-size:11px;color:var(--txt3);margin-bottom:12px">Elige una plantilla o crea un lienzo personalizado</p>
    <div class="wiz-grid">
      <div class="wiz-card" onclick="pickTemplate('estudio')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1"/><rect x="2" y="2" width="42" height="36" fill="var(--accg)" stroke="var(--brd2)" stroke-width=".7"/><text x="23" y="23" font-size="5" fill="var(--txt2)" text-anchor="middle">Sala</text><rect x="44" y="2" width="24" height="20" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="56" y="14" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Bano</text><rect x="44" y="22" width="24" height="16" fill="#f5edec" stroke="var(--brd2)" stroke-width=".7"/><text x="56" y="32" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Cocina</text><rect x="2" y="38" width="66" height="18" fill="#f5f3ec" stroke="var(--brd2)" stroke-width=".7"/><text x="35" y="50" font-size="5" fill="var(--txt2)" text-anchor="middle">Dormitorio</text></svg>
        <h4>Estudio</h4>
        <span class="wiz-info">~35 m² &middot; 1 ambiente</span>
      </div>
      <div class="wiz-card" onclick="pickTemplate('1hab')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1"/><rect x="2" y="2" width="34" height="30" fill="#f2f0eb" stroke="var(--brd2)" stroke-width=".7"/><text x="19" y="20" font-size="5" fill="var(--txt2)" text-anchor="middle">Dormitorio</text><rect x="36" y="2" width="32" height="30" fill="#f5f3ec" stroke="var(--brd2)" stroke-width=".7"/><text x="52" y="20" font-size="5" fill="var(--txt2)" text-anchor="middle">Sala</text><rect x="2" y="32" width="24" height="24" fill="#f5edec" stroke="var(--brd2)" stroke-width=".7"/><text x="14" y="47" font-size="5" fill="var(--txt2)" text-anchor="middle">Cocina</text><rect x="26" y="32" width="20" height="24" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="36" y="47" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Bano</text><rect x="46" y="32" width="22" height="24" fill="#f7f6f3" stroke="var(--brd2)" stroke-width=".7"/><text x="57" y="47" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Pasillo</text></svg>
        <h4>1 Habitacion</h4>
        <span class="wiz-info">~50 m² &middot; 4 ambientes</span>
      </div>
      <div class="wiz-card" onclick="pickTemplate('2hab')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1"/><rect x="2" y="2" width="34" height="26" fill="#f2f0eb" stroke="var(--brd2)" stroke-width=".7"/><text x="19" y="18" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Hab. Princ.</text><rect x="36" y="2" width="32" height="26" fill="#f5f2ed" stroke="var(--brd2)" stroke-width=".7"/><text x="52" y="18" font-size="5" fill="var(--txt2)" text-anchor="middle">Hab. 2</text><rect x="2" y="28" width="40" height="28" fill="#f5f3ec" stroke="var(--brd2)" stroke-width=".7"/><text x="22" y="45" font-size="5" fill="var(--txt2)" text-anchor="middle">Sala-Comedor</text><rect x="42" y="28" width="26" height="14" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="55" y="37" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Bano</text><rect x="42" y="42" width="26" height="14" fill="#f5edec" stroke="var(--brd2)" stroke-width=".7"/><text x="55" y="52" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Cocina</text></svg>
        <h4>2 Habitaciones</h4>
        <span class="wiz-info">~70 m² &middot; 5 ambientes</span>
      </div>
      <div class="wiz-card" onclick="pickTemplate('3hab')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1"/><rect x="2" y="2" width="30" height="22" fill="#f5f2ed" stroke="var(--brd2)" stroke-width=".7"/><text x="17" y="15" font-size="4" fill="var(--txt2)" text-anchor="middle">Hab. 2</text><rect x="32" y="2" width="36" height="22" fill="#f2f0eb" stroke="var(--brd2)" stroke-width=".7"/><text x="50" y="15" font-size="4" fill="var(--txt2)" text-anchor="middle">Hab. 1</text><rect x="2" y="24" width="24" height="18" fill="#f3eef5" stroke="var(--brd2)" stroke-width=".7"/><text x="14" y="35" font-size="4" fill="var(--txt2)" text-anchor="middle">Hab. 3</text><rect x="26" y="24" width="14" height="18" fill="#f7f6f3" stroke="var(--brd2)" stroke-width=".7"/><rect x="40" y="24" width="28" height="18" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="54" y="35" font-size="4" fill="var(--txt2)" text-anchor="middle">Banos</text><rect x="2" y="42" width="42" height="14" fill="#f5f3ec" stroke="var(--brd2)" stroke-width=".7"/><text x="23" y="52" font-size="4.5" fill="var(--txt2)" text-anchor="middle">Sala-Comedor</text><rect x="44" y="42" width="24" height="14" fill="#f5edec" stroke="var(--brd2)" stroke-width=".7"/><text x="56" y="52" font-size="4" fill="var(--txt2)" text-anchor="middle">Cocina</text></svg>
        <h4>Mi Apartamento</h4>
        <span class="wiz-info">~85 m² &middot; 9 ambientes</span>
      </div>
      <div class="wiz-card" onclick="pickTemplate('casa')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1"/><rect x="2" y="2" width="22" height="18" fill="#f2f0eb" stroke="var(--brd2)" stroke-width=".7"/><text x="13" y="13" font-size="3.5" fill="var(--txt2)" text-anchor="middle">Hab.1</text><rect x="24" y="2" width="22" height="18" fill="#f5f2ed" stroke="var(--brd2)" stroke-width=".7"/><text x="35" y="13" font-size="3.5" fill="var(--txt2)" text-anchor="middle">Hab.2</text><rect x="46" y="2" width="22" height="18" fill="#f3eef5" stroke="var(--brd2)" stroke-width=".7"/><text x="57" y="13" font-size="3.5" fill="var(--txt2)" text-anchor="middle">Hab.3</text><rect x="2" y="20" width="14" height="12" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="9" y="28" font-size="3" fill="var(--txt2)" text-anchor="middle">B.1</text><rect x="16" y="20" width="14" height="12" fill="#eaf2f5" stroke="var(--brd2)" stroke-width=".7"/><text x="23" y="28" font-size="3" fill="var(--txt2)" text-anchor="middle">B.2</text><rect x="30" y="20" width="38" height="12" fill="#f7f6f3" stroke="var(--brd2)" stroke-width=".7"/><text x="49" y="28" font-size="3.5" fill="var(--txt2)" text-anchor="middle">Pasillo</text><rect x="2" y="32" width="34" height="24" fill="#f5f3ec" stroke="var(--brd2)" stroke-width=".7"/><text x="19" y="47" font-size="4" fill="var(--txt2)" text-anchor="middle">Sala-Comedor</text><rect x="36" y="32" width="18" height="24" fill="#f5edec" stroke="var(--brd2)" stroke-width=".7"/><text x="45" y="47" font-size="3.5" fill="var(--txt2)" text-anchor="middle">Cocina</text><rect x="54" y="32" width="14" height="24" fill="#edf5ef" stroke="var(--brd2)" stroke-width=".7"/><text x="61" y="47" font-size="3" fill="var(--txt2)" text-anchor="middle">Patio</text></svg>
        <h4>Casa Pequena</h4>
        <span class="wiz-info">~100 m² &middot; 10 ambientes</span>
      </div>
      <div class="wiz-card" onclick="pickTemplate('vacio')">
        <svg width="70" height="58" viewBox="0 0 70 58"><rect x="2" y="2" width="66" height="54" fill="none" stroke="var(--txt3)" stroke-width="1.5" rx="1" stroke-dasharray="3,2"/><text x="35" y="32" font-size="6" fill="var(--txt3)" text-anchor="middle">Vacio</text></svg>
        <h4>Lienzo Vacio</h4>
        <span class="wiz-info">Dimensiones actuales</span>
      </div>
    </div>
    <div class="wiz-sep">o personalizado</div>
    <div class="wiz-custom">
      <div class="wiz-field" style="flex:1;min-width:100px"><label>Nombre</label><input type="text" id="wizName" value="Mi plano" style="width:100%;text-align:left" autocomplete="off"></div>
      <div class="wiz-field"><label>Ancho (m)</label><input type="number" id="wizW" value="8.5" min="2" max="30" step=".1"></div>
      <div class="wiz-field"><label>Alto (m)</label><input type="number" id="wizH" value="10.1" min="2" max="30" step=".1"></div>
      <button class="mob pr" onclick="buildCustom()" style="height:32px;padding:0 16px">Crear</button>
      <button class="mob" onclick="$('wizmodal').classList.remove('vis')" style="height:32px">Cancelar</button>
    </div>
  </div>
</div>

<div class="mo" id="helpmodal">
  <div class="mod" style="min-width:560px;max-width:620px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h3 style="margin:0">Manual de Uso</h3>
      <button class="mob" onclick="$('helpmodal').classList.remove('vis')" style="padding:4px 10px">Cerrar</button>
    </div>
    <div class="help-body">

      <div class="help-intro">
        Bienvenido a <b>ArquiPlan</b>, un editor visual de planos arquitectonicos. Aqui puedes dibujar habitaciones, agregar muebles, medir distancias y exportar tu plano. Todo funciona directamente en el navegador, sin instalar nada.
      </div>

      <!-- QUICK START -->
      <div class="help-sec open">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          <span>Primeros Pasos (Guia Rapida)</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <div class="help-step"><div class="help-num">1</div><div class="help-stxt"><b>Crear o abrir un plano</b><br>Haz click en <b>+ Nuevo</b> en la barra superior para elegir una plantilla (estudio, 1-3 habitaciones, casa) o crear un lienzo vacio con medidas personalizadas.</div></div>
          <div class="help-step"><div class="help-num">2</div><div class="help-stxt"><b>Configurar la escala</b><br>En la barra superior, ajusta <b>Ancho</b> y <b>Alto</b> en metros reales. Esto afecta todas las medidas y cotas del plano.</div></div>
          <div class="help-step"><div class="help-num">3</div><div class="help-stxt"><b>Editar habitaciones</b><br>Haz click en cualquier habitacion para seleccionarla. Arrastra para moverla. Usa los <b>cuadros blancos</b> en las esquinas para redimensionar. Haz <b>doble click</b> para editar el nombre.</div></div>
          <div class="help-step"><div class="help-num">4</div><div class="help-stxt"><b>Agregar elementos</b><br>Usa la <b>barra de herramientas</b> (izquierda) para dibujar habitaciones, paredes, puertas, ventanas o texto. Tambien puedes <b>arrastrar muebles</b> desde la biblioteca del panel derecho directamente al plano.</div></div>
          <div class="help-step"><div class="help-num">5</div><div class="help-stxt"><b>Navegar el plano</b><br>Usa la <b>rueda del mouse</b> para zoom. Mantiene <b>Alt + click</b> para mover la vista (pan). O selecciona la herramienta <b>Mover vista (H)</b>.</div></div>
          <div class="help-step"><div class="help-num">6</div><div class="help-stxt"><b>Guardar y exportar</b><br>Click en <b>Guardar</b> o usa <b>Ctrl+S</b>. Se auto-guarda cada 30 seg. Exporta como <b>SVG</b>, <b>PNG</b>, <b>PDF</b> o archivo <b>.json</b> portable.</div></div>
          <div class="help-tip"><b>Tip:</b> Mantiene <b>Shift</b> mientras arrastras para mover en linea recta (solo X o solo Y).</div>
        </div>
      </div>

      <!-- TOOLS -->
      <div class="help-sec">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
          <span>Herramientas</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <table class="help-tbl">
            <tr><th>Herramienta</th><th>Tecla</th><th>Descripcion</th></tr>
            <tr><td>Seleccionar</td><td><span class="help-kbd">V</span></td><td>Click para seleccionar. Arrastrar para mover. Shift+click para multi-seleccion.</td></tr>
            <tr><td>Mover vista</td><td><span class="help-kbd">H</span></td><td>Arrastra para mover la vista del plano. Tambien: Alt+click en cualquier modo.</td></tr>
            <tr><td>Habitacion</td><td><span class="help-kbd">R</span></td><td>Click y arrastra para dibujar un rectangulo de habitacion.</td></tr>
            <tr><td>Pared</td><td><span class="help-kbd">W</span></td><td>Dibuja un muro/tabique con patron de tramado.</td></tr>
            <tr><td>Puerta</td><td><span class="help-kbd">D</span></td><td>Dibuja una puerta con arco de apertura. Se adhiere a paredes cercanas.</td></tr>
            <tr><td>Ventana</td><td><span class="help-kbd">N</span></td><td>Dibuja una ventana. Se adhiere automaticamente a paredes cercanas.</td></tr>
            <tr><td>Texto</td><td><span class="help-kbd">T</span></td><td>Agrega una etiqueta de texto libre en el plano.</td></tr>
            <tr><td>Cota</td><td><span class="help-kbd">M</span></td><td>Mide la distancia entre 2 puntos. Click en inicio y fin.</td></tr>
            <tr><td>Borrador</td><td><span class="help-kbd">E</span></td><td>Click en un elemento para eliminarlo.</td></tr>
          </table>
        </div>
      </div>

      <!-- KEYBOARD -->
      <div class="help-sec">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"/></svg>
          <span>Atajos de Teclado</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <table class="help-tbl">
            <tr><th>Atajo</th><th>Accion</th></tr>
            <tr><td><span class="help-kbd">Ctrl</span>+<span class="help-kbd">Z</span></td><td>Deshacer</td></tr>
            <tr><td><span class="help-kbd">Ctrl</span>+<span class="help-kbd">Y</span></td><td>Rehacer</td></tr>
            <tr><td><span class="help-kbd">Ctrl</span>+<span class="help-kbd">C</span></td><td>Copiar seleccion</td></tr>
            <tr><td><span class="help-kbd">Ctrl</span>+<span class="help-kbd">V</span></td><td>Pegar</td></tr>
            <tr><td><span class="help-kbd">Ctrl</span>+<span class="help-kbd">D</span></td><td>Duplicar seleccion</td></tr>
            <tr><td><span class="help-kbd">R</span></td><td>Rotar 90 grados (con seleccion) / Herramienta habitacion (sin seleccion)</td></tr>
            <tr><td><span class="help-kbd">Delete</span></td><td>Eliminar seleccion</td></tr>
            <tr><td><span class="help-kbd">Escape</span></td><td>Deseleccionar todo</td></tr>
            <tr><td><span class="help-kbd">Shift</span>+Click</td><td>Agregar/quitar de multi-seleccion</td></tr>
            <tr><td><span class="help-kbd">Shift</span>+Arrastrar</td><td>Restringir movimiento a un eje (X o Y)</td></tr>
            <tr><td>Doble click</td><td>Editar nombre del elemento</td></tr>
            <tr><td>Click derecho</td><td>Menu contextual (duplicar, rotar, eliminar...)</td></tr>
            <tr><td>Scroll</td><td>Zoom in/out</td></tr>
            <tr><td><span class="help-kbd">Alt</span>+Click</td><td>Mover vista (pan)</td></tr>
          </table>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="help-sec">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          <span>Panel Derecho</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <p><b>Propiedades</b> - Al seleccionar un elemento, muestra su ancho, alto, area y posicion en metros. Puedes editar el nombre y cambiar el color de relleno.</p>
          <p style="margin-top:6px"><b>Alineacion</b> - Cuando seleccionas 2 o mas elementos (Shift+click), aparecen botones para alinearlos (izquierda, centro, derecha) y distribuirlos uniformemente.</p>
          <p style="margin-top:6px"><b>Imagen de Fondo</b> - Muestra los controles de opacidad si has importado una imagen de fondo.</p>
          <p style="margin-top:6px"><b>Capas</b> - Checkboxes para ocultar/mostrar tipos de elementos: habitaciones, paredes, puertas, muebles, textos, cotas, escala.</p>
          <p style="margin-top:6px"><b>Areas</b> - Lista automatica de todas las habitaciones con su area individual y el total en metros cuadrados.</p>
          <p style="margin-top:6px"><b>Muebles</b> - Biblioteca de 18 muebles organizados por categoria (Sala, Dormitorio, Bano, Cocina, Simbolos). <b>Arrastra</b> cualquier mueble directamente al plano.</p>
          <p style="margin-top:6px"><b>Colores</b> - Paleta rapida de 16 colores para aplicar al elemento seleccionado.</p>
        </div>
      </div>

      <!-- PROJECTS & EXPORT -->
      <div class="help-sec">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
          <span>Proyectos y Exportacion</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <p><b>Nuevo (+)</b> - Abre el asistente con plantillas predefinidas o lienzo personalizado.</p>
          <p style="margin-top:6px"><b>Abrir</b> - Abre la lista de proyectos guardados. Click en el nombre para cargar, flecha para descargar, X para eliminar.</p>
          <p style="margin-top:6px"><b>Guardar</b> - Guarda el proyecto (Ctrl+S). El menu desplegable ofrece: Guardar como, Exportar/Importar archivo .json.</p>
          <p style="margin-top:6px"><b>Reset</b> - Vuelve al plano original por defecto (3 habitaciones).</p>
          <div style="height:8px"></div>
          <p><b>Exportar SVG</b> - Descarga el plano como archivo SVG vectorial (editable en Illustrator, Inkscape, etc).</p>
          <p style="margin-top:6px"><b>Exportar PNG</b> - Descarga como imagen de 1600x2000 pixeles.</p>
          <p style="margin-top:6px"><b>Exportar PDF</b> - Abre una vista de impresion con escala configurable (1:50, 1:100), tabla de areas y metadatos. Usa "Guardar como PDF" del navegador.</p>
          <div class="help-tip"><b>Tip:</b> Los proyectos se guardan en el almacenamiento local del navegador. Si limpias los datos del sitio, se perderan.</div>
        </div>
      </div>

      <!-- FEATURES -->
      <div class="help-sec">
        <div class="help-hdr" onclick="togHelp(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          <span>Funciones Especiales</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="help-cnt">
          <p><b>Snap inteligente</b> - Al mover un elemento, se alinea automaticamente con los bordes de otros elementos cercanos (guias verdes). Puertas y ventanas se adhieren a paredes.</p>
          <p style="margin-top:6px"><b>Paredes inteligentes</b> - Al redimensionar una habitacion, si otra habitacion comparte el mismo borde, ambas se ajustan automaticamente.</p>
          <p style="margin-top:6px"><b>Rotacion</b> - Selecciona un elemento y presiona <span class="help-kbd">R</span> para rotar 90 grados. Tambien puedes arrastrar el circulo azul que aparece arriba del elemento.</p>
          <p style="margin-top:6px"><b>Lasso</b> - Click y arrastra en un area vacia para seleccionar multiples elementos con un rectangulo.</p>
          <p style="margin-top:6px"><b>Imagen de fondo</b> - Boton "Fondo" importa una imagen (foto, scan) semitransparente para calcar encima. Ajusta la opacidad desde el panel derecho.</p>
          <p style="margin-top:6px"><b>Pisos automaticos</b> - Las habitaciones muestran patrones de piso segun su nombre: madera para dormitorios/sala, azulejos para bano, tablero para cocina.</p>
          <p style="margin-top:6px"><b>Reglas</b> - Los bordes del canvas muestran reglas con medidas en metros que se actualizan con el zoom.</p>
          <p style="margin-top:6px"><b>Modo claro/oscuro</b> - Toggle con el icono de luna en la barra superior.</p>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="toasts"></div>
<input type="file" id="finput" accept=".svg,.xml" style="display:none" onchange="onFile(event)">
<input type="file" id="bginput" accept="image/*" style="display:none" onchange="onBgFile(event)">
<input type="file" id="projinput" accept=".json" style="display:none" onchange="importProjectFile(event)">

<script>
// ═══════════════════════════════════════════════════════════════
// BLOCK-BASED FLOOR PLAN EDITOR v7
// Projects, bg image, alignment, rulers, light/dark mode, visual upgrade
// ═══════════════════════════════════════════════════════════════

const $=id=>document.getElementById(id);
const NS='http://www.w3.org/2000/svg';
const ce=t=>document.createElementNS(NS,t);
const canvas=$('canvas'),wrap=$('svgwrap'),ctx=$('ctx');

// STATE
const S={
  tool:'select',zoom:1,px:0,py:0,
  panning:false,ps:{x:0,y:0},
  // Multi-selection
  sels:[],
  drag:false,ds:{x:0,y:0},dragOs:[],
  // Lasso
  lasso:false,lassoS:null,lassoEl:null,
  // Resize
  rsz:false,rszH:null,rszO:null,
  // Rotation
  rot:false,rotC:null,rotS:0,rotOs:[],
  // Draw
  draw:false,drawS:{x:0,y:0},drawEl:null,
  // Dim tool
  dimPt:null,
  // Clipboard
  clipboard:[],
  // History
  hist:[],hi:-1,
  // Scale
  WPx:700,HPx:850,WM:8.5,HM:10.1,OX:50,OY:80,
  snap:true,snapSz:10,gridOn:false,dimsOn:true,scaleOn:true,rulersOn:true,
  bgImgData:null,bgOpacity:0.3,lightMode:false,
  currentProject:null,dirty:false,
  mcb:null
};
// Convenience getter for primary selection
Object.defineProperty(S,'sel',{get(){return S.sels[0]||null}});
let svg,selG,gridG,dimG,liveG,snapG,blocksG,scaleG,bgImgG;

// ═══════════════════════════════════════════════════════════════
// SCALE
// ═══════════════════════════════════════════════════════════════
const px2mx=p=>(p/S.WPx)*S.WM;
const px2my=p=>(p/S.HPx)*S.HM;
const m2px=m=>(m/S.WM)*S.WPx;
const m2py=m=>(m/S.HM)*S.HPx;
function updScale(){S.WM=+$('sw').value||8.5;S.HM=+$('sh').value||10.1;updScaleDisp();if(S.sel)showProps(S.sel);drawGrid();updAutoDims()}
function updScaleDisp(){$('sscale').textContent=`${S.WM}m x ${S.HM}m`}
function calcGeometry(wm,hm){
  const maxW=720,maxH=880,ar=wm/hm;
  if(ar>=maxW/maxH){S.WPx=maxW;S.HPx=Math.round(maxW/ar)}
  else{S.HPx=maxH;S.WPx=Math.round(maxH*ar)}
  S.OX=Math.round((800-S.WPx)/2);S.OY=Math.round((1000-S.HPx)/2);
}

// ═══════════════════════════════════════════════════════════════
// TRANSFORM
// ═══════════════════════════════════════════════════════════════
function applyTx(){wrap.style.transform=`translate(${S.px}px,${S.py}px) scale(${S.zoom})`;$('zlbl').textContent=Math.round(S.zoom*100)+'%';drawRulers()}
function zin(){sz(S.zoom*1.25)}function zout(){sz(S.zoom/1.25)}
function sz(z,cx,cy){const o=S.zoom;S.zoom=Math.max(.05,Math.min(15,z));if(cx!=null){S.px=cx-(cx-S.px)*(S.zoom/o);S.py=cy-(cy-S.py)*(S.zoom/o)}applyTx()}
function fit(){const w=canvas.clientWidth,h=canvas.clientHeight;S.zoom=Math.min(w/800,h/1000)*.88;S.px=(w-800*S.zoom)/2;S.py=(h-1000*S.zoom)/2;applyTx()}
function c2s(cx,cy){const r=canvas.getBoundingClientRect();return{x:(cx-r.left-S.px)/S.zoom,y:(cy-r.top-S.py)/S.zoom}}
function sn(v){return S.snap?Math.round(v/S.snapSz)*S.snapSz:v}

// ═══════════════════════════════════════════════════════════════
// BLOCK HELPERS
// ═══════════════════════════════════════════════════════════════
function gPos(g){
  const t=g.getAttribute('transform')||'';
  const m=t.match(/translate\(\s*([^,\s]+)[\s,]+([^)]+)\)/);
  return m?{x:+m[1],y:+m[2]}:{x:0,y:0};
}
function sPos(g,x,y){
  const rot=+g.getAttribute('data-rot')||0;
  const fh=+g.getAttribute('data-fliph')||0;
  const fv=+g.getAttribute('data-flipv')||0;
  const mr=gMainRect(g);
  const w=mr?+mr.getAttribute('width'):0,h=mr?+mr.getAttribute('height'):0;
  let tf=`translate(${x},${y})`;
  if(rot) tf+=` rotate(${rot},${w/2},${h/2})`;
  if(fh) tf+=` translate(${w},0) scale(-1,1)`;
  if(fv) tf+=` translate(0,${h}) scale(1,-1)`;
  g.setAttribute('transform',tf);
}
function gRect(g){
  const r=g.querySelector('rect');
  if(!r)return null;
  const p=gPos(g);
  return{x:p.x+(+r.getAttribute('x')||0),y:p.y+(+r.getAttribute('y')||0),w:+r.getAttribute('width')||0,h:+r.getAttribute('height')||0};
}
function gMainRect(g){return g.querySelector('rect')}
function sa(el,o){for(const[k,v]of Object.entries(o))el.setAttribute(k,String(v))}
function rangesOverlap(a1,a2,b1,b2){return a1<b2&&a2>b1}

// Z-Order layer priority
const Z_ORDER={boundary:0,room:1,wall:2,door:3,window:3,furniture:4,label:5,dimension:5,custom:5};
function insertByLayer(g){
  const myZ=Z_ORDER[g.getAttribute('data-type')]??5;
  const kids=[...blocksG.children];
  for(let i=kids.length-1;i>=0;i--){
    const cz=Z_ORDER[kids[i].getAttribute('data-type')]??5;
    if(cz<=myZ){blocksG.insertBefore(g,kids[i].nextSibling);return}
  }
  blocksG.insertBefore(g,blocksG.firstChild);
}
function sortBlocksZ(){
  const kids=[...blocksG.children];
  kids.sort((a,b)=>(Z_ORDER[a.getAttribute('data-type')]??5)-(Z_ORDER[b.getAttribute('data-type')]??5));
  kids.forEach(k=>blocksG.appendChild(k));
}

// Shape presets (normalized 0-1 vertices, scaled to bounding rect)
const SHAPE_PRESETS={
  'rect':null,
  'L-tl':[[0,0],[.5,0],[.5,.5],[1,.5],[1,1],[0,1]],
  'L-tr':[[0,0],[1,0],[1,1],[.5,1],[.5,.5],[0,.5]],
  'L-bl':[[0,0],[1,0],[1,.5],[.5,.5],[.5,1],[0,1]],
  'L-br':[[0,.5],[.5,.5],[.5,0],[1,0],[1,1],[0,1]],
  'U':[[0,0],[1,0],[1,1],[.75,1],[.75,.35],[.25,.35],[.25,1],[0,1]],
  'T':[[0,0],[1,0],[1,.35],[.75,.35],[.75,1],[.25,1],[.25,.35],[0,.35]]
};
const SHAPE_LABELS={'rect':'\u25ad','L-tl':'L\u2196','L-tr':'L\u2197','L-bl':'L\u2199','L-br':'L\u2198','U':'U','T':'T'};

function polyPoints(g){
  const d=g.getAttribute('data-poly');
  if(!d)return null;
  return d.trim().split(/\s+/).map(p=>{const[x,y]=p.split(',');return[+x,+y]});
}
function polyArea(pts){
  let a=0;
  for(let i=0,n=pts.length;i<n;i++){const j=(i+1)%n;a+=pts[i][0]*pts[j][1]-pts[j][0]*pts[i][1]}
  return Math.abs(a)/2;
}
function polyCentroid(pts){
  let cx=0,cy=0,a=0;
  for(let i=0,n=pts.length;i<n;i++){
    const j=(i+1)%n;const cross=pts[i][0]*pts[j][1]-pts[j][0]*pts[i][1];
    cx+=(pts[i][0]+pts[j][0])*cross;cy+=(pts[i][1]+pts[j][1])*cross;a+=cross;
  }
  a/=2;if(Math.abs(a)<0.001)return{x:pts[0][0],y:pts[0][1]};
  return{x:cx/(6*a),y:cy/(6*a)};
}
function updateRoomPoly(g){
  const pts=polyPoints(g);if(!pts)return;
  const pointsStr=pts.map(p=>p.join(',')).join(' ');
  const mr=gMainRect(g);if(!mr)return;
  // Create or update room-poly
  let poly=g.querySelector('.room-poly');
  if(!poly){
    poly=ce('polygon');poly.setAttribute('class','room-poly');
    poly.setAttribute('fill',mr.getAttribute('fill')||'#f5f2ed');
    poly.setAttribute('stroke',mr.getAttribute('stroke')||'#3a3a3a');
    poly.setAttribute('stroke-width',mr.getAttribute('stroke-width')||'3.5');
    const flt=mr.getAttribute('filter');if(flt)poly.setAttribute('filter',flt);
    mr.setAttribute('fill','none');mr.setAttribute('stroke','none');mr.removeAttribute('filter');
    g.insertBefore(poly,mr.nextSibling);
  }
  poly.setAttribute('points',pointsStr);
  // Update tile overlay: convert rect to polygon if needed
  let tile=g.querySelector('.room-tile');
  if(tile&&tile.tagName.toLowerCase()==='rect'){
    const np=ce('polygon');np.setAttribute('points',pointsStr);
    np.setAttribute('fill',tile.getAttribute('fill'));np.setAttribute('stroke','none');
    np.setAttribute('class','room-tile');np.setAttribute('pointer-events','none');
    tile.replaceWith(np);
  }else if(tile&&tile.tagName.toLowerCase()==='polygon'){
    tile.setAttribute('points',pointsStr);
  }
  // Update bounding rect
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  pts.forEach(([x,y])=>{minX=Math.min(minX,x);minY=Math.min(minY,y);maxX=Math.max(maxX,x);maxY=Math.max(maxY,y)});
  mr.setAttribute('x',minX);mr.setAttribute('y',minY);mr.setAttribute('width',maxX-minX);mr.setAttribute('height',maxY-minY);
}
function centerLabelsForPoly(g){
  const pts=polyPoints(g);if(!pts)return;
  const c=polyCentroid(pts);
  const lbl=g.querySelector('.room-label');
  const sub=g.querySelector('.room-sub');
  if(lbl){lbl.setAttribute('x',Math.round(c.x));
    const tp=g.getAttribute('data-text-pos')||'center';
    let minY=Infinity,maxY=-Infinity;pts.forEach(([x,y])=>{minY=Math.min(minY,y);maxY=Math.max(maxY,y)});
    let ly;if(tp==='top')ly=minY+20;else if(tp==='bottom')ly=maxY-10;else ly=Math.round(c.y)+(sub?-4:4);
    lbl.setAttribute('y',ly);
  }
  if(sub){sub.setAttribute('x',Math.round(c.x));sub.setAttribute('y',(+lbl.getAttribute('y'))+18)}
}
function setRoomShape(g,preset){
  if(preset==='rect'){
    g.removeAttribute('data-poly');
    const poly=g.querySelector('.room-poly');if(poly){
      const mr=gMainRect(g);
      mr.setAttribute('fill',poly.getAttribute('fill')||'#f5f2ed');
      mr.setAttribute('stroke',poly.getAttribute('stroke')||'#3a3a3a');
      mr.setAttribute('stroke-width',poly.getAttribute('stroke-width')||'3.5');
      mr.setAttribute('filter','url(#roomShd)');
      poly.remove();
    }
    // Restore tile as rect
    const tile=g.querySelector('.room-tile');
    if(tile&&tile.tagName.toLowerCase()==='polygon'){
      const mr=gMainRect(g);const w=+mr.getAttribute('width'),ht=+mr.getAttribute('height');
      const nr=ce('rect');sa(nr,{x:0,y:0,width:w,height:ht,fill:tile.getAttribute('fill'),stroke:'none','pointer-events':'none'});
      nr.setAttribute('class','room-tile');tile.replaceWith(nr);
    }
    centerLabels(g);pushH();updAutoDims();return;
  }
  const sp=SHAPE_PRESETS[preset];if(!sp)return;
  const mr=gMainRect(g);
  const w=+mr.getAttribute('width'),ht=+mr.getAttribute('height');
  if(w<20||ht<20)return;
  const pts=sp.map(([px,py])=>[Math.round(px*w),Math.round(py*ht)]);
  g.setAttribute('data-poly',pts.map(p=>p.join(',')).join(' '));
  updateRoomPoly(g);centerLabelsForPoly(g);pushH();updAutoDims();
}

// ═══════════════════════════════════════════════════════════════
// BLOCK CREATION HELPERS
// ═══════════════════════════════════════════════════════════════
function mkRoom(x,y,w,h,fill,name,sub,txtColor){
  const g=ce('g');g.setAttribute('class','room-block');g.setAttribute('data-type','room');g.setAttribute('data-name',name);
  sPos(g,x,y);
  const r=ce('rect');r.setAttribute('x',0);r.setAttribute('y',0);r.setAttribute('width',w);r.setAttribute('height',h);
  r.setAttribute('fill',fill);r.setAttribute('stroke','#3a3a3a');r.setAttribute('stroke-width','3.5');r.setAttribute('class','room-rect');
  r.setAttribute('filter','url(#roomShd)');
  g.appendChild(r);
  // Floor tile pattern overlay (context-aware)
  const nl=(name||'').toLowerCase();
  let tileId='ftile';
  if(nl.includes('bano')||nl.includes('baño'))tileId='fBath';
  else if(nl.includes('cocina'))tileId='fKitchen';
  else if(nl.includes('habitacion')||nl.includes('sala')||nl.includes('dormitorio')||nl.includes('comedor'))tileId='fWood';
  const ft=ce('rect');ft.setAttribute('x',0);ft.setAttribute('y',0);ft.setAttribute('width',w);ft.setAttribute('height',h);
  ft.setAttribute('fill','url(#'+tileId+')');ft.setAttribute('stroke','none');ft.setAttribute('class','room-tile');ft.setAttribute('pointer-events','none');
  g.appendChild(ft);
  const t=ce('text');t.setAttribute('x',w/2);t.setAttribute('y',h/2+(sub?-6:4));t.setAttribute('text-anchor','middle');
  t.setAttribute('font-size',Math.min(18,w/7));t.setAttribute('fill',txtColor||'#3a3a3a');t.setAttribute('font-weight','700');
  t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','room-label');t.textContent=name;
  g.appendChild(t);
  if(sub){const s=ce('text');s.setAttribute('x',w/2);s.setAttribute('y',h/2+13);s.setAttribute('text-anchor','middle');
    s.setAttribute('font-size','11');s.setAttribute('fill','#888');s.setAttribute('font-family','Inter,Arial,sans-serif');
    s.setAttribute('class','room-sub');s.textContent=sub;g.appendChild(s)}
  return g;
}

function mkWall(x,y,w,h,name){
  const g=ce('g');g.setAttribute('class','wall-block');g.setAttribute('data-type','wall');g.setAttribute('data-name',name||'Pared');
  sPos(g,x,y);
  const r=ce('rect');r.setAttribute('x',0);r.setAttribute('y',0);r.setAttribute('width',w);r.setAttribute('height',h);
  r.setAttribute('fill','#4a4a4a');r.setAttribute('stroke','#333');r.setAttribute('stroke-width','1');
  g.appendChild(r);
  const r2=ce('rect');r2.setAttribute('x',0);r2.setAttribute('y',0);r2.setAttribute('width',w);r2.setAttribute('height',h);
  r2.setAttribute('fill','url(#hatch)');r2.setAttribute('stroke','none');g.appendChild(r2);
  if(name&&(w>30||h>30)){const t=ce('text');
    const vert=h>w;
    t.setAttribute('x',w/2);t.setAttribute('y',h/2+4);t.setAttribute('text-anchor','middle');
    t.setAttribute('font-size','10');t.setAttribute('fill','#ddd');t.setAttribute('font-weight','600');
    t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','room-label');
    if(vert)t.setAttribute('transform',`rotate(-90,${w/2},${h/2})`);
    t.textContent=name;g.appendChild(t)}
  return g;
}

function mkDoor(x,y,w,horiz){
  const g=ce('g');g.setAttribute('class','door-block');g.setAttribute('data-type','door');
  sPos(g,x,y);
  const thick=10;
  const r=ce('rect');r.setAttribute('x',0);r.setAttribute('y',0);
  r.setAttribute('width',horiz?w:thick);r.setAttribute('height',horiz?thick:w);
  r.setAttribute('fill','transparent');r.setAttribute('stroke','none');
  g.appendChild(r);
  buildDoorParts(g,w,thick,horiz);
  return g;
}
function buildDoorParts(g,w,thick,horiz){
  const leaf=ce('line');
  if(horiz){leaf.setAttribute('x1',0);leaf.setAttribute('y1',thick);leaf.setAttribute('x2',w);leaf.setAttribute('y2',thick)}
  else{leaf.setAttribute('x1',thick);leaf.setAttribute('y1',0);leaf.setAttribute('x2',thick);leaf.setAttribute('y2',w)}
  leaf.setAttribute('stroke','#333');leaf.setAttribute('stroke-width','2');leaf.setAttribute('class','door-part');
  g.appendChild(leaf);
  const arc=ce('path');
  if(horiz){arc.setAttribute('d',`M${w},${thick} A${w},${w} 0 0,1 0,${thick-w}`)}
  else{arc.setAttribute('d',`M${thick},${w} A${w},${w} 0 0,0 ${thick+w},0`)}
  arc.setAttribute('fill','none');arc.setAttribute('stroke','#333');arc.setAttribute('stroke-width','0.8');arc.setAttribute('class','door-part');
  g.appendChild(arc);
}

function mkWindow(x,y,w,horiz){
  const g=ce('g');g.setAttribute('class','win-block');g.setAttribute('data-type','window');
  sPos(g,x,y);
  const thick=8;
  const r=ce('rect');r.setAttribute('x',0);r.setAttribute('y',0);
  r.setAttribute('width',horiz?w:thick);r.setAttribute('height',horiz?thick:w);
  r.setAttribute('fill','transparent');r.setAttribute('stroke','none');
  g.appendChild(r);
  buildWinParts(g,w,thick,horiz);
  return g;
}
function buildWinParts(g,w,thick,horiz){
  const l1=ce('line'),l2=ce('line'),lg=ce('line');
  if(horiz){
    sa(l1,{x1:0,y1:0,x2:w,y2:0});sa(l2,{x1:0,y1:thick,x2:w,y2:thick});
    sa(lg,{x1:0,y1:thick/2,x2:w,y2:thick/2});
  }else{
    sa(l1,{x1:0,y1:0,x2:0,y2:w});sa(l2,{x1:thick,y1:0,x2:thick,y2:w});
    sa(lg,{x1:thick/2,y1:0,x2:thick/2,y2:w});
  }
  [l1,l2].forEach(l=>{l.setAttribute('stroke','#333');l.setAttribute('stroke-width','2');l.setAttribute('class','win-part')});
  lg.setAttribute('stroke','#333');lg.setAttribute('stroke-width','0.6');lg.setAttribute('class','win-part');
  g.appendChild(l1);g.appendChild(l2);g.appendChild(lg);
}

function mkFurn(x,y,w,h,fill,name){
  const g=ce('g');g.setAttribute('class','furn-block');g.setAttribute('data-type','furniture');g.setAttribute('data-name',name);g.setAttribute('data-furn',name);
  sPos(g,x,y);
  const r=ce('rect');r.setAttribute('x',0);r.setAttribute('y',0);r.setAttribute('width',w);r.setAttribute('height',h);
  r.setAttribute('fill',fill);r.setAttribute('stroke','#555');r.setAttribute('stroke-width','1');r.setAttribute('rx','2');
  g.appendChild(r);
  addFurnShape(g,name,w,h);
  const t=ce('text');t.setAttribute('x',w/2);t.setAttribute('y',h/2+4);t.setAttribute('text-anchor','middle');
  t.setAttribute('font-size',Math.min(11,w/5));t.setAttribute('fill','#333');t.setAttribute('font-weight','600');
  t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','room-label');t.textContent=name;
  g.appendChild(t);
  return g;
}

function addFurnShape(g,name,w,h){
  const ar=(x,y,rw,rh,fill,opts)=>{const e=ce('rect');sa(e,Object.assign({x,y,width:rw,height:rh,fill,class:'furn-detail'},opts||{}));g.appendChild(e)};
  const ac=(cx,cy,r,fill,opts)=>{const e=ce('circle');sa(e,Object.assign({cx,cy,r,fill,class:'furn-detail'},opts||{}));g.appendChild(e)};
  const ae=(cx,cy,rx,ry,fill,opts)=>{const e=ce('ellipse');sa(e,Object.assign({cx,cy,rx,ry,fill,class:'furn-detail'},opts||{}));g.appendChild(e)};
  const al=(x1,y1,x2,y2,opts)=>{const e=ce('line');sa(e,Object.assign({x1,y1,x2,y2,stroke:'#333','stroke-width':'0.8',class:'furn-detail'},opts||{}));g.appendChild(e)};
  const ap=(d,fill,opts)=>{const e=ce('path');sa(e,Object.assign({d,fill,class:'furn-detail'},opts||{}));g.appendChild(e)};
  switch(name){
    case 'Sofa':
      ar(0,0,w,h*.22,'none',{rx:2,stroke:'#333','stroke-width':'1'});
      ar(0,0,w*.08,h,'none',{rx:2,stroke:'#333','stroke-width':'1'});
      ar(w*.92,0,w*.08,h,'none',{rx:2,stroke:'#333','stroke-width':'1'});
      {const sw2=(w-w*.16)/3;for(let i=1;i<3;i++){al(w*.08+i*sw2,h*.25,w*.08+i*sw2,h*.95,{stroke:'#555','stroke-width':'.5'})}}
      break;
    case 'Mesa':
      ae(w/2,h/2,w*.42,h*.42,'none',{stroke:'#333','stroke-width':'.8'});
      break;
    case 'Cama':
      ar(0,0,w,h*.04,'#555',{rx:1});
      ar(w*.06,h*.06,w*.40,h*.12,'none',{rx:3,stroke:'#333','stroke-width':'.8'});
      ar(w*.54,h*.06,w*.40,h*.12,'none',{rx:3,stroke:'#333','stroke-width':'.8'});
      al(w*.04,h*.28,w*.96,h*.28,{stroke:'#555','stroke-width':'.6'});
      break;
    case 'Inodoro':
      ar(w*.1,h*.02,w*.8,h*.28,'none',{rx:2,stroke:'#333','stroke-width':'1'});
      ap(`M${w*.12},${h*.98} L${w*.12},${h*.45} Q${w*.12},${h*.32} ${w*.5},${h*.32} Q${w*.88},${h*.32} ${w*.88},${h*.45} L${w*.88},${h*.98}`,'none',{stroke:'#333','stroke-width':'1'});
      break;
    case 'Ducha':
      al(w*.05,h*.05,w*.95,h*.95,{stroke:'#555','stroke-width':'.8'});
      al(w*.95,h*.05,w*.05,h*.95,{stroke:'#555','stroke-width':'.8'});
      ac(w/2,h/2,Math.min(w,h)*.05,'none',{stroke:'#333','stroke-width':'.8'});
      break;
    case 'Lavabo':
      ap(`M${w*.05},${h*.05} L${w*.95},${h*.05} L${w*.95},${h*.4} Q${w*.95},${h*.92} ${w*.5},${h*.92} Q${w*.05},${h*.92} ${w*.05},${h*.4} Z`,'none',{stroke:'#333','stroke-width':'1'});
      ac(w*.5,h*.55,Math.min(w,h)*.06,'none',{stroke:'#333','stroke-width':'.8'});
      ac(w*.35,h*.2,Math.min(w,h)*.04,'#333',{});
      ac(w*.65,h*.2,Math.min(w,h)*.04,'#333',{});
      break;
    case 'Estufa':
      [[.3,.3],[.7,.3],[.3,.7],[.7,.7]].forEach(([px,py])=>{
        const cr=Math.min(w,h)*.16;
        ac(w*px,h*py,cr,'none',{stroke:'#333','stroke-width':'1'});
        ac(w*px,h*py,cr*.5,'none',{stroke:'#555','stroke-width':'.6'});
      });
      break;
    case 'Nevera':
      al(w*.05,h*.35,w*.95,h*.35,{stroke:'#333','stroke-width':'1'});
      al(w*.85,h*.12,w*.85,h*.28,{stroke:'#333','stroke-width':'1.2','stroke-linecap':'round'});
      al(w*.85,h*.42,w*.85,h*.88,{stroke:'#333','stroke-width':'1.2','stroke-linecap':'round'});
      break;
    case 'Gran Isla':
      ar(w*.06,h*.06,w*.88,h*.88,'none',{rx:2,stroke:'#555','stroke-width':'.6'});
      ae(w*.5,h*.3,w*.15,h*.08,'none',{stroke:'#333','stroke-width':'.8'});
      ac(w*.5,h*.3,Math.min(w,h)*.02,'#333',{});
      break;
    case 'Silla':
      ar(w*.12,h*.22,w*.76,h*.72,'none',{rx:2,stroke:'#333','stroke-width':'.8'});
      ar(w*.08,h*.02,w*.84,h*.16,'none',{rx:2,stroke:'#333','stroke-width':'1'});
      break;
    case 'TV':
      ar(w*.02,h*.1,w*.96,h*.55,'none',{rx:1,stroke:'#333','stroke-width':'.8'});
      ar(w*.4,h*.7,w*.2,h*.25,'none',{rx:1,stroke:'#555','stroke-width':'.6'});
      break;
    case 'Chimenea':
      // Firebox opening (arch)
      ap(`M${w*.12},${h*.98} L${w*.12},${h*.35} Q${w*.12},${h*.08} ${w*.5},${h*.08} Q${w*.88},${h*.08} ${w*.88},${h*.35} L${w*.88},${h*.98}`,'none',{stroke:'#333','stroke-width':'1'});
      // Hearth line at bottom
      al(w*.05,h*.92,w*.95,h*.92,{stroke:'#333','stroke-width':'1'});
      break;
    case 'Escritorio':
      ar(0,0,w,h*.12,'none',{rx:1,stroke:'#333','stroke-width':'1'});
      ar(w*.05,h*.55,w*.42,h*.38,'none',{rx:1,stroke:'#555','stroke-width':'.6'});
      al(w*.15,h*.74,w*.37,h*.74,{stroke:'#555','stroke-width':'.5'});
      break;
    case 'Lavadora':
      ac(w/2,h*.55,Math.min(w,h)*.32,'none',{stroke:'#333','stroke-width':'1'});
      ac(w/2,h*.55,Math.min(w,h)*.18,'none',{stroke:'#555','stroke-width':'.6'});
      ar(w*.1,h*.03,w*.3,h*.1,'none',{rx:1,stroke:'#555','stroke-width':'.6'});
      break;
    case 'Bañera':
      ae(w/2,h/2,w*.38,h*.42,'none',{stroke:'#333','stroke-width':'1'});
      ac(w*.5,h*.15,Math.min(w,h)*.03,'#333',{});
      break;
    case 'Armario':
      al(w/2,h*.05,w/2,h*.95,{stroke:'#333','stroke-width':'.8'});
      ac(w*.42,h/2,Math.min(w,h)*.04,'#333',{});
      ac(w*.58,h/2,Math.min(w,h)*.04,'#333',{});
      break;
    case 'Mesa de noche':
      al(w*.08,h*.48,w*.92,h*.48,{stroke:'#333','stroke-width':'.8'});
      ac(w/2,h*.26,Math.min(w,h)*.04,'#333',{});
      break;
    case 'Escalera':
      {const steps=8;
       for(let i=0;i<=steps;i++){al(w*.05,h*i/steps,w*.95,h*i/steps,{stroke:'#333','stroke-width':'.6'})}
       al(w*.05,h*.65,w*.95,h*.65,{stroke:'#333','stroke-width':'1.5'});
       al(w*.5,h*.85,w*.5,h*.15,{stroke:'#333','stroke-width':'1'});
       ap(`M${w*.38},${h*.25} L${w*.5},${h*.1} L${w*.62},${h*.25}`,'none',{stroke:'#333','stroke-width':'1','stroke-linejoin':'miter'});
      }
      break;
    case 'Columna':
      ar(w*.08,h*.08,w*.84,h*.84,'#333',{stroke:'#222','stroke-width':'1'});
      al(w*.08,h*.08,w*.92,h*.92,{stroke:'#555','stroke-width':'.5'});
      al(w*.92,h*.08,w*.08,h*.92,{stroke:'#555','stroke-width':'.5'});
      break;
    case 'Flecha Norte':
      ap(`M${w/2},${h*.05} L${w*.75},${h*.55} L${w/2},${h*.42} L${w*.25},${h*.55} Z`,'none',{stroke:'#333','stroke-width':'.8'});
      ap(`M${w/2},${h*.05} L${w*.75},${h*.55} L${w/2},${h*.42} Z`,'#222',{stroke:'none'});
      {const t=ce('text');t.setAttribute('x',w/2);t.setAttribute('y',h*.82);
       t.setAttribute('text-anchor','middle');t.setAttribute('font-size',Math.min(w,h)*.35);
       t.setAttribute('fill','#333');t.setAttribute('font-weight','700');
       t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','furn-detail');
       t.textContent='N';g.appendChild(t)}
      break;
  }
}

function mkLabel(x,y,text,size,color){
  const g=ce('g');g.setAttribute('class','furn-block');g.setAttribute('data-type','label');g.setAttribute('data-name',text);
  sPos(g,x,y);
  const t=ce('text');t.setAttribute('x',0);t.setAttribute('y',0);t.setAttribute('text-anchor','middle');
  t.setAttribute('font-size',size||16);t.setAttribute('fill',color||'#444');t.setAttribute('font-weight','600');
  t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','room-label');t.textContent=text;
  g.appendChild(t);
  return g;
}

// ═══════════════════════════════════════════════════════════════
// BUILD DEFAULT PLAN
// ═══════════════════════════════════════════════════════════════
function buildPlan(){
  S.WPx=700;S.HPx=850;S.OX=50;S.OY=80;
  wrap.innerHTML=`<svg id="msvg" viewBox="0 0 800 1000" xmlns="${NS}">
  <defs>
    <marker id="as" markerWidth="8" markerHeight="8" refX="2" refY="4" orient="auto"><path d="M8,0L0,4L8,8" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--pink')}" stroke-width="1.5"/></marker>
    <marker id="ae" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0L8,4L0,8" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--pink')}" stroke-width="1.5"/></marker>
    <filter id="shd" x="-2%" y="-2%" width="104%" height="104%"><feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity=".06"/></filter>
    <filter id="planShd" x="-3%" y="-2%" width="106%" height="106%"><feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#000" flood-opacity=".12"/></filter>
    <filter id="roomShd" x="-1%" y="-1%" width="102%" height="102%"><feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#000" flood-opacity=".06"/></filter>
    <pattern id="hatch" width="6" height="6" patternUnits="userSpaceOnUse"><line x1="0" y1="6" x2="6" y2="0" stroke="#bbb" stroke-width=".5" opacity=".35"/></pattern>
    <pattern id="ftile" width="18" height="18" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="18" height="18" fill="none" stroke="rgba(0,0,0,.03)" stroke-width=".3"/></pattern>
    <pattern id="fBath" width="10" height="10" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="10" height="10" fill="none" stroke="rgba(0,0,0,.06)" stroke-width=".3"/></pattern>
    <pattern id="fKitchen" width="20" height="20" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="20" height="20" fill="none" stroke="rgba(0,0,0,.04)" stroke-width=".4"/></pattern>
    <pattern id="fWood" width="40" height="8" patternUnits="userSpaceOnUse"><line x1="0" y1="7.5" x2="40" y2="7.5" stroke="rgba(0,0,0,.05)" stroke-width=".4"/><line x1="20" y1="0" x2="20" y2="8" stroke="rgba(0,0,0,.03)" stroke-width=".2"/></pattern>
    <pattern id="wallFill" width="4" height="4" patternUnits="userSpaceOnUse"><rect width="4" height="4" fill="#3a3a3a"/><line x1="0" y1="4" x2="4" y2="0" stroke="#555" stroke-width=".4" opacity=".3"/></pattern>
  </defs>
  <rect x="0" y="0" width="800" height="1000" fill="#f0ede6" rx="3"/>
  <g id="gridG" style="display:none"></g>
  <g id="bgImgG"></g>
  <g id="blocksG"></g>
  <g id="scaleG"></g>
  <g id="dimG"></g>
  <g id="snapG"></g>
  <g id="liveG"></g>
  <g id="selG"></g>
</svg>`;
  svg=wrap.querySelector('svg');svg.style.width='800px';svg.style.height='1000px';
  gridG=svg.querySelector('#gridG');bgImgG=svg.querySelector('#bgImgG');blocksG=svg.querySelector('#blocksG');scaleG=svg.querySelector('#scaleG');
  dimG=svg.querySelector('#dimG');snapG=svg.querySelector('#snapG');
  liveG=svg.querySelector('#liveG');selG=svg.querySelector('#selG');

  insertByLayer(mkLabel(400,45,'Plano Base Conceptual - 85.85 m2',22,'#2d3436'));

  const bnd=ce('g');bnd.setAttribute('class','wall-block');bnd.setAttribute('data-type','boundary');bnd.setAttribute('data-name','Perimetro');
  sPos(bnd,50,80);
  const br=ce('rect');br.setAttribute('x',0);br.setAttribute('y',0);br.setAttribute('width',700);br.setAttribute('height',850);
  br.setAttribute('fill','none');br.setAttribute('stroke','#2d2d2d');br.setAttribute('stroke-width','8');br.setAttribute('filter','url(#planShd)');bnd.appendChild(br);
  insertByLayer(bnd);

  const rooms=[
    [50,80,350,300,'#f5f2ed','Habitacion 2','(Futuro Estudio)','#4a4a4a'],
    [400,80,350,300,'#f2f0eb','Habitacion 1 (Principal)',null,'#4a4a4a'],
    [550,380,200,120,'#eaf2f5','Bano Privado',null,'#3a6b8a'],
    [550,500,200,120,'#eaf2f5','Bano Social',null,'#3a6b8a'],
    [550,620,200,130,'#edf5ef','Patio / Lavadero',null,'#3a7a5a'],
    [50,380,280,250,'#f3eef5','Habitacion 3 (Belen)',null,'#5a3a6a'],
    [370,380,180,250,'#f7f6f3','Pasillo',null,'#999'],
    [50,630,500,300,'#f5f3ec','Sala - Comedor',null,'#7a6830'],
    [550,750,200,180,'#f5edec','Cocina',null,'#8a3a3a'],
  ];
  rooms.forEach(r=>insertByLayer(mkRoom(...r)));
  insertByLayer(mkWall(330,380,40,250,'Muro Closet'));
  insertByLayer(mkWindow(55,76,90,true));
  insertByLayer(mkWindow(255,76,90,true));
  insertByLayer(mkWindow(605,76,90,true));
  insertByLayer(mkWindow(46,685,140,false));
  insertByLayer(mkDoor(405,925,70,true));
  insertByLayer(mkLabel(440,965,'PUERTA ENTRADA',12,'#3a3a3a'));
  insertByLayer(mkFurn(455,785,75,110,'#ffca28','Gran Isla'));
}

// ═══════════════════════════════════════════════════════════════
// AUTO DIMENSIONS
// ═══════════════════════════════════════════════════════════════
function updAutoDims(){
  calcTotalArea();drawScaleBar();
  if(!S.dimsOn){dimG.innerHTML='';return}
  dimG.innerHTML='';
  blocksG.querySelectorAll('[data-type="room"]').forEach(g=>{
    const rc=gRect(g);if(!rc||rc.w<40||rc.h<40)return;
    const mw=px2mx(rc.w).toFixed(2),mh=px2my(rc.h).toFixed(2);
    const dt=ce('text');dt.setAttribute('class','room-dims');
    dt.setAttribute('x',rc.x+rc.w-6);dt.setAttribute('y',rc.y+rc.h-8);
    dt.setAttribute('text-anchor','end');dt.setAttribute('font-size','10');
    dt.setAttribute('fill','rgba(0,0,0,.3)');dt.setAttribute('font-family','Inter,Arial,sans-serif');dt.setAttribute('font-weight','500');
    dt.textContent=`${mw} x ${mh}m`;
    dimG.appendChild(dt);
  });
}
function togDims(){S.dimsOn=$('dimck').checked;updAutoDims()}

// ═══════════════════════════════════════════════════════════════
// EVENTS
// ═══════════════════════════════════════════════════════════════
function setup(){
  canvas.addEventListener('wheel',onWh,{passive:false});
  canvas.addEventListener('mousedown',onDn);
  window.addEventListener('mousemove',onMv);
  window.addEventListener('mouseup',onUp);
  document.addEventListener('keydown',onKy);
  document.addEventListener('click',e=>{ctx.classList.remove('vis');if(!e.target.closest('.save-wrap'))closeSaveDD()});
  canvas.addEventListener('dblclick',onDbl);
  // Drag & drop from library
  canvas.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy'});
  canvas.addEventListener('drop',onDrop);
  // Auto-save every 30 seconds if dirty
  setInterval(()=>{if(S.dirty&&S.currentProject){saveProjectByName(S.currentProject);toast('Auto-guardado','ok')}},30000);
  $('minput').addEventListener('keydown',e=>{if(e.key==='Enter')modalOk();if(e.key==='Escape')modalNo()});
}

function onWh(e){e.preventDefault();const f=e.deltaY<0?1.12:1/1.12;const r=canvas.getBoundingClientRect();sz(S.zoom*f,e.clientX-r.left,e.clientY-r.top)}

function onDn(e){
  const p=c2s(e.clientX,e.clientY);ctx.classList.remove('vis');
  if(e.button===2){if(S.sels.length>0){ctx.style.left=e.clientX+'px';ctx.style.top=e.clientY+'px';ctx.classList.add('vis')}return}
  if(e.button===1||S.tool==='pan'||(e.button===0&&e.altKey)){S.panning=true;S.ps={x:e.clientX-S.px,y:e.clientY-S.py};canvas.classList.add('panning');return}
  if(e.button===0){
    if(S.tool==='select'||S.tool==='eraser')selDn(e,p);
    else if(S.tool==='dim')dimDn(p);
    else if(['room','wall','door','window','text'].includes(S.tool))drawDn(p);
  }
}

function onMv(e){
  const p=c2s(e.clientX,e.clientY);updPos(p);
  if(S.panning){S.px=e.clientX-S.ps.x;S.py=e.clientY-S.ps.y;applyTx();return}
  if(S.rot){rotMv(p);return}
  if(S.lasso&&S.lassoEl){lassoMv(p);return}
  if(S.drag&&S.sels.length>0){dragMv(p,e.shiftKey);return}
  if(S.rsz&&S.sels.length>0){rszMv(p);return}
  if(S.draw&&S.drawEl){drawMv(p);return}
}

function onUp(){
  if(S.panning){S.panning=false;canvas.classList.remove('panning');return}
  if(S.rot){S.rot=false;pushH();drawSelHandles();return}
  if(S.lasso){lassoUp();return}
  if(S.drag){S.drag=false;snapG.innerHTML='';pushH();updAutoDims();
    if(S.sels.length===1)showProps(S.sels[0]);else if(S.sels.length>1)showMultiProps();return}
  if(S.rsz){S.rsz=false;S.rszH=null;pushH();updAutoDims();if(S.sel)showProps(S.sel);return}
  if(S.draw){drawUp();return}
}

function onKy(e){
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
  const c=e.ctrlKey||e.metaKey;
  if(e.key==='Delete'||e.key==='Backspace'){e.preventDefault();delSel()}
  else if(e.key==='z'&&c&&!e.shiftKey){e.preventDefault();undo()}
  else if((e.key==='y'&&c)||(e.key==='z'&&c&&e.shiftKey)){e.preventDefault();redo()}
  else if(e.key==='s'&&c){e.preventDefault();saveProject()}
  else if(e.key==='d'&&c){e.preventDefault();dup()}
  // Copy/Paste
  else if(e.key==='c'&&c){e.preventDefault();clipCopy()}
  else if(e.key==='v'&&c){e.preventDefault();clipPaste()}
  else if(e.key==='Escape'){desel();cancelDraw();S.dimPt=null}
  // R for rotation, H for flip horizontal, V for flip vertical (when selected)
  else if(e.key==='r'&&!c&&S.sels.length>0){e.preventDefault();rot90()}
  else if(e.key==='h'&&!c&&S.sels.length>0){e.preventDefault();flipH()}
  else if(e.key==='v'&&!c&&S.sels.length>0){e.preventDefault();flipV()}
  else if(!c){const m={v:'select',h:'pan',r:'room',w:'wall',d:'door',n:'window',t:'text',m:'dim',e:'eraser'};if(m[e.key]){e.preventDefault();setT(m[e.key])}}
}

// ═══════════════════════════════════════════════════════════════
// TOOL
// ═══════════════════════════════════════════════════════════════
function setT(t){
  S.tool=t;
  document.querySelectorAll('.tbn').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
  canvas.className='';
  if(t==='pan')canvas.classList.add('pan');
  else if(['room','wall','door','window','text','dim'].includes(t))canvas.classList.add('draw');
  else if(t==='eraser')canvas.classList.add('erase');
  if(!['select','eraser'].includes(t))desel();
  $('sinfo').textContent={select:'Seleccionar',pan:'Mover',room:'Habitacion',wall:'Pared',door:'Puerta',window:'Ventana',text:'Texto',dim:'Cota',eraser:'Borrar'}[t]||t;
}

// ═══════════════════════════════════════════════════════════════
// SELECTION (Multi-select + Lasso)
// ═══════════════════════════════════════════════════════════════
function selDn(e,p){
  // Resize handle?
  const h=e.target.closest('.sel-h');
  if(h){startRsz(h,p);return}
  // Rotation handle?
  const rh=e.target.closest('.rot-h');
  if(rh){startRot(p);return}
  // Find block
  const blk=findBlock(e.target);
  if(blk){
    if(S.tool==='eraser'){blk.remove();pushH();updAutoDims();toast('Eliminado','w');return}
    if(e.shiftKey){
      // Toggle in multi-selection
      selToggle(blk);
    }else{
      if(!S.sels.includes(blk))sel(blk);
    }
    // Start drag for all selected
    S.drag=true;S.ds={x:p.x,y:p.y};
    S.dragOs=S.sels.map(g=>({g,...gPos(g)}));
  }else{
    if(!e.shiftKey)desel();
    // Start lasso
    S.lasso=true;S.lassoS={x:p.x,y:p.y};
    S.lassoEl=ce('rect');S.lassoEl.setAttribute('class','lasso-rect');
    S.lassoEl.setAttribute('x',p.x);S.lassoEl.setAttribute('y',p.y);
    S.lassoEl.setAttribute('width',0);S.lassoEl.setAttribute('height',0);
    selG.appendChild(S.lassoEl);
  }
}

function findBlock(t){
  if(!t)return null;
  let el=t;
  while(el){
    if(el.parentElement===blocksG)return el;
    if(el===svg||el===canvas||el===wrap)return null;
    el=el.parentElement;
  }
  return null;
}

function sel(g){
  S.sels=[g];drawSelHandles();showProps(g);$('propsec').style.display='block';
}

function selToggle(g){
  if(S.sels.includes(g)){
    S.sels=S.sels.filter(s=>s!==g);
    if(S.sels.length===0){desel();return}
  }else{
    S.sels.push(g);
  }
  drawSelHandles();
  if(S.sels.length===1){showProps(S.sels[0])}else{showMultiProps()}
  $('propsec').style.display='block';
}

function desel(){S.sels=[];selG.innerHTML='';liveG.innerHTML='';snapG.innerHTML='';$('propsec').style.display='none';$('alignsec').style.display='none'}

// ═══════════════════════════════════════════════════════════════
// LASSO SELECTION
// ═══════════════════════════════════════════════════════════════
function lassoMv(p){
  const x=Math.min(S.lassoS.x,p.x),y=Math.min(S.lassoS.y,p.y);
  const w=Math.abs(p.x-S.lassoS.x),h=Math.abs(p.y-S.lassoS.y);
  S.lassoEl.setAttribute('x',x);S.lassoEl.setAttribute('y',y);
  S.lassoEl.setAttribute('width',w);S.lassoEl.setAttribute('height',h);
}

function lassoUp(){
  S.lasso=false;
  if(!S.lassoEl)return;
  const lx=+S.lassoEl.getAttribute('x'),ly=+S.lassoEl.getAttribute('y');
  const lw=+S.lassoEl.getAttribute('width'),lh=+S.lassoEl.getAttribute('height');
  S.lassoEl.remove();S.lassoEl=null;
  if(lw<5&&lh<5)return; // Just a click, no drag
  const found=[];
  blocksG.querySelectorAll('[data-type]').forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    if(rc.x+rc.w>lx&&rc.x<lx+lw&&rc.y+rc.h>ly&&rc.y<ly+lh)found.push(g);
  });
  if(found.length>0){
    S.sels=found;
    drawSelHandles();
    if(found.length===1)showProps(found[0]);else showMultiProps();
    $('propsec').style.display='block';
    toast(found.length+' elementos','ok');
  }
}

// ═══════════════════════════════════════════════════════════════
// SELECTION HANDLES (multi-aware + rotation handle)
// ═══════════════════════════════════════════════════════════════
function drawSelHandles(){
  selG.innerHTML='';liveG.innerHTML='';
  if(S.sels.length===0)return;
  // Bounding box of all selected
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.sels.forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    minX=Math.min(minX,rc.x);minY=Math.min(minY,rc.y);
    maxX=Math.max(maxX,rc.x+rc.w);maxY=Math.max(maxY,rc.y+rc.h);
  });
  if(minX===Infinity)return;
  const bw=maxX-minX,bh=maxY-minY;
  // Individual selection fills
  S.sels.forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    const f=ce('rect');f.setAttribute('x',rc.x);f.setAttribute('y',rc.y);
    f.setAttribute('width',rc.w);f.setAttribute('height',rc.h);
    f.setAttribute('class','sel-fill');selG.appendChild(f);
  });
  // Bounding box
  const b=ce('rect');b.setAttribute('x',minX-2);b.setAttribute('y',minY-2);
  b.setAttribute('width',bw+4);b.setAttribute('height',bh+4);
  b.setAttribute('class','sel-box');selG.appendChild(b);
  showLive({x:minX,y:minY,w:bw,h:bh});
  // Resize handles (single selection only)
  if(S.sels.length===1){
    const rc=gRect(S.sels[0]);
    if(rc){
      const hs=8/S.zoom;
      [{x:rc.x,y:rc.y,id:'nw',c:'nw-resize'},{x:rc.x+rc.w/2,y:rc.y,id:'n',c:'n-resize'},
       {x:rc.x+rc.w,y:rc.y,id:'ne',c:'ne-resize'},{x:rc.x+rc.w,y:rc.y+rc.h/2,id:'e',c:'e-resize'},
       {x:rc.x+rc.w,y:rc.y+rc.h,id:'se',c:'se-resize'},{x:rc.x+rc.w/2,y:rc.y+rc.h,id:'s',c:'s-resize'},
       {x:rc.x,y:rc.y+rc.h,id:'sw',c:'sw-resize'},{x:rc.x,y:rc.y+rc.h/2,id:'w',c:'w-resize'}
      ].forEach(pt=>{
        const r=ce('rect');r.setAttribute('x',pt.x-hs/2);r.setAttribute('y',pt.y-hs/2);
        r.setAttribute('width',hs);r.setAttribute('height',hs);r.setAttribute('class','sel-h');
        r.setAttribute('data-h',pt.id);r.style.cursor=pt.c;selG.appendChild(r);
      });
    }
  }
  // Rotation handle
  const rhs=7/S.zoom;
  const cx=minX+bw/2,cy=minY-25;
  const rl=ce('line');rl.setAttribute('x1',cx);rl.setAttribute('y1',minY);
  rl.setAttribute('x2',cx);rl.setAttribute('y2',cy+rhs);
  rl.setAttribute('class','rot-line');selG.appendChild(rl);
  const rc2=ce('circle');rc2.setAttribute('cx',cx);rc2.setAttribute('cy',cy);
  rc2.setAttribute('r',rhs);rc2.setAttribute('class','rot-h');selG.appendChild(rc2);
}


function showLive(rc){
  liveG.innerHTML='';
  const mw=px2mx(rc.w),mh=px2my(rc.h);
  if(mw<.03&&mh<.03)return;
  const fs=Math.max(10,Math.min(14,14/S.zoom));
  if(mw>.03){const t=ce('text');t.setAttribute('x',rc.x+rc.w/2);t.setAttribute('y',rc.y-7);t.setAttribute('class','live-t');t.setAttribute('font-size',fs);t.textContent=mw.toFixed(2)+'m';liveG.appendChild(t)}
  if(mh>.03){const t=ce('text');t.setAttribute('x',rc.x+rc.w+8);t.setAttribute('y',rc.y+rc.h/2+4);t.setAttribute('class','live-t');t.setAttribute('font-size',fs);t.setAttribute('text-anchor','start');t.textContent=mh.toFixed(2)+'m';liveG.appendChild(t)}
  if(mw>.3&&mh>.3){const t=ce('text');t.setAttribute('x',rc.x+rc.w/2);t.setAttribute('y',rc.y+rc.h/2+16);t.setAttribute('text-anchor','middle');t.setAttribute('font-size',fs-2);t.setAttribute('fill','rgba(91,141,239,.45)');t.setAttribute('font-weight','600');t.setAttribute('pointer-events','none');t.textContent=(mw*mh).toFixed(1)+' m2';liveG.appendChild(t)}
}

// ═══════════════════════════════════════════════════════════════
// ROTATION
// ═══════════════════════════════════════════════════════════════
function startRot(p){
  if(S.sels.length===0)return;
  S.rot=true;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.sels.forEach(g=>{const rc=gRect(g);if(!rc)return;minX=Math.min(minX,rc.x);minY=Math.min(minY,rc.y);maxX=Math.max(maxX,rc.x+rc.w);maxY=Math.max(maxY,rc.y+rc.h)});
  S.rotC={x:(minX+maxX)/2,y:(minY+maxY)/2};
  S.rotS=Math.atan2(p.y-S.rotC.y,p.x-S.rotC.x);
  S.rotOs=S.sels.map(g=>({g,rot:+g.getAttribute('data-rot')||0}));
}

function rotMv(p){
  const angle=Math.atan2(p.y-S.rotC.y,p.x-S.rotC.x);
  let delta=((angle-S.rotS)*180/Math.PI);
  if(S.snap)delta=Math.round(delta/15)*15;
  S.rotOs.forEach(orig=>{
    const nr=(orig.rot+delta)%360;
    orig.g.setAttribute('data-rot',nr);
    const pos=gPos(orig.g);sPos(orig.g,pos.x,pos.y);
  });
  drawSelHandles();
}

function rot90(){
  if(S.sels.length===0)return;
  S.sels.forEach(g=>{
    const cur=+g.getAttribute('data-rot')||0;
    g.setAttribute('data-rot',(cur+90)%360);
    const pos=gPos(g);sPos(g,pos.x,pos.y);
  });
  drawSelHandles();pushH();ctx.classList.remove('vis');
  toast('Rotado 90°','ok');
}
function flipH(){
  if(S.sels.length===0)return;
  S.sels.forEach(g=>{
    const cur=+g.getAttribute('data-fliph')||0;
    g.setAttribute('data-fliph',cur?0:1);
    const pos=gPos(g);sPos(g,pos.x,pos.y);
    // Flip label text back so it stays readable
    g.querySelectorAll('.room-label').forEach(t=>{
      const mr=gMainRect(g);if(!mr)return;
      const w=+mr.getAttribute('width');
      t.setAttribute('transform',cur?'':`translate(${w},0) scale(-1,1)`);
    });
  });
  drawSelHandles();pushH();ctx.classList.remove('vis');
  toast('Volteado H','ok');
}
function flipV(){
  if(S.sels.length===0)return;
  S.sels.forEach(g=>{
    const cur=+g.getAttribute('data-flipv')||0;
    g.setAttribute('data-flipv',cur?0:1);
    const pos=gPos(g);sPos(g,pos.x,pos.y);
    // Flip label text back so it stays readable
    g.querySelectorAll('.room-label').forEach(t=>{
      const mr=gMainRect(g);if(!mr)return;
      const h=+mr.getAttribute('height');
      t.setAttribute('transform',cur?'':`translate(0,${h}) scale(1,-1)`);
    });
  });
  drawSelHandles();pushH();ctx.classList.remove('vis');
  toast('Volteado V','ok');
}

// ═══════════════════════════════════════════════════════════════
// SMART SNAP + WALL SNAP
// ═══════════════════════════════════════════════════════════════
function smartSnap(g,nx,ny,w,h){
  if(!S.snap)return{x:nx,y:ny};
  snapG.innerHTML='';
  const thresh=8;
  let bx=nx,by=ny;
  const edges=[];
  blocksG.querySelectorAll('[data-type]').forEach(other=>{
    if(S.sels.includes(other))return;
    const or=gRect(other);if(!or)return;
    edges.push({l:or.x,r:or.x+or.w,t:or.y,b:or.y+or.h,cx:or.x+or.w/2,cy:or.y+or.h/2,type:other.getAttribute('data-type')});
  });
  const me={l:nx,r:nx+w,t:ny,b:ny+h,cx:nx+w/2,cy:ny+h/2};
  let snX=null,snY=null;
  for(const e of edges){
    for(const [,myV] of [['l',me.l],['r',me.r],['cx',me.cx]]){
      for(const [,otV] of [['l',e.l],['r',e.r],['cx',e.cx]]){
        if(Math.abs(myV-otV)<thresh){bx=nx+(otV-myV);snX=otV;break}
      }
      if(snX!=null)break;
    }
    if(snX!=null)break;
  }
  for(const e of edges){
    for(const [,myV] of [['t',me.t],['b',me.b],['cy',me.cy]]){
      for(const [,otV] of [['t',e.t],['b',e.b],['cy',e.cy]]){
        if(Math.abs(myV-otV)<thresh){by=ny+(otV-myV);snY=otV;break}
      }
      if(snY!=null)break;
    }
    if(snY!=null)break;
  }
  // Wall snap for doors/windows: snap to room edges
  const dt=g.getAttribute('data-type');
  if(dt==='door'||dt==='window'){
    const ws=wallSnap(g,bx,by,w,h);bx=ws.x;by=ws.y;
  }
  if(snX!=null){const l=ce('line');l.setAttribute('x1',snX);l.setAttribute('y1',0);l.setAttribute('x2',snX);l.setAttribute('y2',1000);l.setAttribute('class','snap-v');snapG.appendChild(l)}
  if(snY!=null){const l=ce('line');l.setAttribute('x1',0);l.setAttribute('y1',snY);l.setAttribute('x2',800);l.setAttribute('y2',snY);l.setAttribute('class','snap-h');snapG.appendChild(l)}
  return{x:bx,y:by};
}

function wallSnap(g,nx,ny,w,h){
  const thresh=15;let bx=nx,by=ny,bestD=thresh;
  blocksG.querySelectorAll('[data-type="room"],[data-type="boundary"]').forEach(room=>{
    const rc=gRect(room);if(!rc)return;
    // Check if overlapping horizontally with room
    if(nx+w>rc.x&&nx<rc.x+rc.w){
      const dTop=Math.abs(ny+h/2-rc.y);
      if(dTop<bestD){by=rc.y-h/2;bestD=dTop}
      const dBot=Math.abs(ny+h/2-(rc.y+rc.h));
      if(dBot<bestD){by=rc.y+rc.h-h/2;bestD=dBot}
    }
    // Check if overlapping vertically with room
    if(ny+h>rc.y&&ny<rc.y+rc.h){
      const dL=Math.abs(nx+w/2-rc.x);
      if(dL<bestD){bx=rc.x-w/2;bestD=dL}
      const dR=Math.abs(nx+w/2-(rc.x+rc.w));
      if(dR<bestD){bx=rc.x+rc.w-w/2;bestD=dR}
    }
  });
  return{x:bx,y:by};
}

// ═══════════════════════════════════════════════════════════════
// DRAG (Multi-selection aware)
// ═══════════════════════════════════════════════════════════════
function dragMv(p,shift){
  let dx=p.x-S.ds.x,dy=p.y-S.ds.y;
  if(shift){if(Math.abs(dx)>Math.abs(dy))dy=0;else dx=0;}
  if(S.sels.length===1){
    const orig=S.dragOs[0];
    let nx=sn(orig.x+dx),ny=sn(orig.y+dy);
    const mr=gMainRect(orig.g);
    const w=mr?+mr.getAttribute('width'):0,h=mr?+mr.getAttribute('height'):0;
    const snapped=smartSnap(orig.g,nx,ny,w,h);
    sPos(orig.g,snapped.x,snapped.y);
  }else{
    snapG.innerHTML='';
    S.dragOs.forEach(orig=>{
      const nx=sn(orig.x+dx),ny=sn(orig.y+dy);
      sPos(orig.g,nx,ny);
    });
  }
  drawSelHandles();
}

// ═══════════════════════════════════════════════════════════════
// RESIZE (single selection only)
// ═══════════════════════════════════════════════════════════════
function startRsz(h,p){
  if(S.sels.length!==1)return;
  S.rsz=true;S.rszH=h.getAttribute('data-h');
  const rc=gRect(S.sels[0]);S.rszO={...rc,gx:gPos(S.sels[0]).x,gy:gPos(S.sels[0]).y,poly:polyPoints(S.sels[0])};
  S.ds={x:p.x,y:p.y};
  S.rszAdj=[];
  if(S.sels[0].getAttribute('data-type')==='room'){
    blocksG.querySelectorAll('[data-type="room"]').forEach(g=>{
      if(g===S.sels[0])return;
      const pos=gPos(g),mr=gMainRect(g);
      if(mr)S.rszAdj.push({g,x:pos.x,y:pos.y,w:+mr.getAttribute('width'),h:+mr.getAttribute('height')});
    });
  }
}

function rszMv(p){
  const g=S.sels[0],mr=gMainRect(g);if(!mr)return;
  const o=S.rszO,h=S.rszH;
  const dx=sn(p.x)-sn(S.ds.x),dy=sn(p.y)-sn(S.ds.y);
  let gx=o.gx,gy=o.gy,w=o.w,ht=o.h;
  if(h.includes('w')){gx=o.gx+dx;w=o.w-dx}
  if(h.includes('e'))w=o.w+dx;
  if(h.includes('n')){gy=o.gy+dy;ht=o.h-dy}
  if(h.includes('s'))ht=o.h+dy;
  if(w<10)w=10;if(ht<10)ht=10;
  sPos(g,gx,gy);
  mr.setAttribute('width',w);mr.setAttribute('height',ht);
  if(o.poly){
    const sx=w/o.w,sy=ht/o.h;
    const newPts=o.poly.map(([px,py])=>[Math.round(px*sx),Math.round(py*sy)]);
    g.setAttribute('data-poly',newPts.map(p=>p.join(',')).join(' '));
  }
  centerLabels(g);
  smartWallResize(g,h,gx,gy,w,ht);
  drawSelHandles();
}

function smartWallResize(g,handle,gx,gy,w,ht){
  if(g.getAttribute('data-type')!=='room'||!S.rszAdj)return;
  const o=S.rszO,thresh=5;
  S.rszAdj.forEach(adj=>{
    const mr=gMainRect(adj.g);if(!mr)return;
    let ax=adj.x,ay=adj.y,aw=adj.w,ah=adj.h,changed=false;
    if(handle.includes('e')){
      const origR=o.gx+o.w;
      if(Math.abs(adj.x-origR)<thresh&&rangesOverlap(o.gy,o.gy+o.h,adj.y,adj.y+adj.h)){
        const delta=gx+w-origR;ax=adj.x+delta;aw=Math.max(10,adj.w-delta);changed=true;
      }
    }
    if(handle.includes('w')){
      const origL=o.gx;
      if(Math.abs(adj.x+adj.w-origL)<thresh&&rangesOverlap(o.gy,o.gy+o.h,adj.y,adj.y+adj.h)){
        const delta=gx-origL;aw=Math.max(10,adj.w-delta);changed=true;
      }
    }
    if(handle.includes('s')){
      const origB=o.gy+o.h;
      if(Math.abs(adj.y-origB)<thresh&&rangesOverlap(o.gx,o.gx+o.w,adj.x,adj.x+adj.w)){
        const delta=gy+ht-origB;ay=adj.y+delta;ah=Math.max(10,adj.h-delta);changed=true;
      }
    }
    if(handle.includes('n')){
      const origT=o.gy;
      if(Math.abs(adj.y+adj.h-origT)<thresh&&rangesOverlap(o.gx,o.gx+o.w,adj.x,adj.x+adj.w)){
        const delta=gy-origT;ah=Math.max(10,adj.h-delta);changed=true;
      }
    }
    if(changed){sPos(adj.g,ax,ay);mr.setAttribute('width',aw);mr.setAttribute('height',ah);centerLabels(adj.g)}
  });
}

function centerLabels(g){
  if(g.getAttribute('data-poly')){updateRoomPoly(g);centerLabelsForPoly(g);return}
  const mr=gMainRect(g);if(!mr)return;
  const w=+mr.getAttribute('width'),h=+mr.getAttribute('height');
  g.querySelectorAll('.room-label').forEach(t=>{t.setAttribute('x',w/2)});
  g.querySelectorAll('.room-sub').forEach(t=>{t.setAttribute('x',w/2)});
  const lbl=g.querySelector('.room-label');
  if(lbl){const sub=g.querySelector('.room-sub');const tp=g.getAttribute('data-text-pos')||'center';let ly;if(tp==='top')ly=20;else if(tp==='bottom')ly=h-10;else ly=h/2+(sub?-4:4);lbl.setAttribute('y',ly);if(sub)sub.setAttribute('y',ly+18)}
  // Update hatch overlay for walls
  if(g.getAttribute('data-type')==='wall'){
    const rects=g.querySelectorAll('rect');
    if(rects[1]){rects[1].setAttribute('width',w);rects[1].setAttribute('height',h)}
  }
  // Update floor tile overlay for rooms
  const tile=g.querySelector('.room-tile');
  if(tile){tile.setAttribute('width',w);tile.setAttribute('height',h)}
  // Rebuild furniture shapes on resize
  const fn=g.getAttribute('data-furn');
  if(fn){g.querySelectorAll('.furn-detail').forEach(e=>e.remove());addFurnShape(g,fn,w,h);const txt=g.querySelector('.room-label');if(txt)g.appendChild(txt)}
  // Rebuild door parts on resize
  if(g.getAttribute('data-type')==='door'){
    g.querySelectorAll('.door-part').forEach(e=>e.remove());
    const aw=+mr.getAttribute('width'),ah=+mr.getAttribute('height');
    const horiz=aw>ah;const dw=horiz?aw:ah;const thick=horiz?ah:aw;
    buildDoorParts(g,dw,thick,horiz);
  }
  // Rebuild window parts on resize
  if(g.getAttribute('data-type')==='window'){
    g.querySelectorAll('.win-part').forEach(e=>e.remove());
    const aw=+mr.getAttribute('width'),ah=+mr.getAttribute('height');
    const horiz=aw>ah;const sw=horiz?aw:ah;const thick=horiz?ah:aw;
    buildWinParts(g,sw,thick,horiz);
  }
}

// ═══════════════════════════════════════════════════════════════
// DRAW NEW ELEMENTS
// ═══════════════════════════════════════════════════════════════
function drawDn(p){
  const sx=sn(p.x),sy=sn(p.y);
  if(S.tool==='text'){
    showModal('Agregar texto','',txt=>{
      if(!txt)return;
      insertByLayer(mkLabel(sx,sy,txt,16,'#444'));
      pushH();updAutoDims();
    });return;
  }
  S.draw=true;S.drawS={x:sx,y:sy};
  if(S.tool==='room'){S.drawEl=mkRoom(sx,sy,0,0,'#f5f2ed','',null,'#4a4a4a');insertByLayer(S.drawEl)}
  else if(S.tool==='wall'){S.drawEl=mkWall(sx,sy,0,0,'');insertByLayer(S.drawEl)}
  else if(S.tool==='door'){S.drawEl=mkDoor(sx,sy,0,true);insertByLayer(S.drawEl)}
  else if(S.tool==='window'){S.drawEl=mkWindow(sx,sy,0,true);insertByLayer(S.drawEl)}
}

function drawMv(p){
  const g=S.drawEl,sx=sn(p.x),sy=sn(p.y);
  const w=sx-S.drawS.x,h=sy-S.drawS.y;
  const mr=gMainRect(g);if(!mr)return;
  if(S.tool==='room'||S.tool==='wall'){
    const ax=Math.min(S.drawS.x,sx),ay=Math.min(S.drawS.y,sy);
    const aw=Math.abs(w),ah=Math.abs(h);
    sPos(g,ax,ay);mr.setAttribute('width',aw);mr.setAttribute('height',ah);
    const h2=g.querySelectorAll('rect')[1];
    if(h2&&g.getAttribute('data-type')==='wall'){h2.setAttribute('width',aw);h2.setAttribute('height',ah)}
  }else{
    const aw=Math.abs(w);
    sPos(g,w>=0?S.drawS.x:sx,S.drawS.y);
    if(S.tool==='door'||S.tool==='window'){mr.setAttribute('width',aw)}
  }
  const rc=gRect(g);if(rc)showLive(rc);
}

function drawUp(){
  S.draw=false;const g=S.drawEl;if(!g){liveG.innerHTML='';return}
  const mr=gMainRect(g);
  const w=mr?+mr.getAttribute('width'):0,h=mr?+mr.getAttribute('height'):0;
  if(w<5&&h<5){g.remove();S.drawEl=null;liveG.innerHTML='';return}
  if(S.tool==='room'){
    showModal('Nombre de la habitacion','',name=>{
      name=name||'Habitacion';
      g.setAttribute('data-name',name);
      const t=ce('text');t.setAttribute('x',w/2);t.setAttribute('y',h/2+4);t.setAttribute('text-anchor','middle');
      t.setAttribute('font-size',Math.min(18,w/7));t.setAttribute('fill','#4a4a4a');t.setAttribute('font-weight','700');
      t.setAttribute('font-family','Inter,Arial,sans-serif');t.setAttribute('class','room-label');t.textContent=name;
      g.appendChild(t);
      pushH();updAutoDims();sel(g);setT('select');
    });
  }else{
    pushH();updAutoDims();sel(g);setT('select');
  }
  S.drawEl=null;
}

function cancelDraw(){if(S.drawEl){S.drawEl.remove();S.drawEl=null}S.draw=false;liveG.innerHTML=''}

// ═══════════════════════════════════════════════════════════════
// DIMENSION TOOL
// ═══════════════════════════════════════════════════════════════
function dimDn(p){
  const sx=sn(p.x),sy=sn(p.y);
  if(!S.dimPt){S.dimPt={x:sx,y:sy};toast('Click segundo punto');return}
  makeDim(S.dimPt.x,S.dimPt.y,sx,sy);S.dimPt=null;pushH();toast('Cota creada','ok');
}

function makeDim(x1,y1,x2,y2){
  const g=ce('g');g.setAttribute('class','dim-g');g.setAttribute('data-type','dimension');
  const dmx=px2mx(Math.abs(x2-x1)),dmy=px2my(Math.abs(y2-y1));
  const ang=Math.atan2(y2-y1,x2-x1),od=22;
  const px=Math.cos(ang+Math.PI/2)*od,py=Math.sin(ang+Math.PI/2)*od;
  [{x:x1,y:y1},{x:x2,y:y2}].forEach(pt=>{const l=ce('line');l.setAttribute('x1',pt.x);l.setAttribute('y1',pt.y);l.setAttribute('x2',pt.x+px);l.setAttribute('y2',pt.y+py);l.setAttribute('class','de');g.appendChild(l)});
  const dl=ce('line');dl.setAttribute('x1',x1+px);dl.setAttribute('y1',y1+py);dl.setAttribute('x2',x2+px);dl.setAttribute('y2',y2+py);dl.setAttribute('class','dl');dl.setAttribute('marker-start','url(#as)');dl.setAttribute('marker-end','url(#ae)');g.appendChild(dl);
  const mx=(x1+x2)/2+px,my=(y1+y2)/2+py;
  let dist=Math.abs(y2-y1)<5?dmx:Math.abs(x2-x1)<5?dmy:Math.sqrt(dmx**2+dmy**2);
  let ad=(ang*180)/Math.PI;if(ad>90||ad<-90)ad+=180;
  const bg=ce('rect');bg.setAttribute('class','dbg');const tw=dist.toFixed(2).length*7+12;
  bg.setAttribute('x',mx-tw/2);bg.setAttribute('y',my-17);bg.setAttribute('width',tw);bg.setAttribute('height',14);
  bg.setAttribute('transform',`rotate(${ad},${mx},${my-6})`);g.appendChild(bg);
  const t=ce('text');t.setAttribute('x',mx);t.setAttribute('y',my-6);t.textContent=dist.toFixed(2)+'m';
  t.setAttribute('transform',`rotate(${ad},${mx},${my-6})`);g.appendChild(t);
  dimG.appendChild(g);
}

function addDimsToSel(){
  if(S.sels.length===0)return;
  S.sels.forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    makeDim(rc.x,rc.y,rc.x+rc.w,rc.y);makeDim(rc.x,rc.y,rc.x,rc.y+rc.h);
  });
  pushH();ctx.classList.remove('vis');toast('Cotas agregadas','ok');
}

// ═══════════════════════════════════════════════════════════════
// COPY / PASTE
// ═══════════════════════════════════════════════════════════════
function clipCopy(){
  if(S.sels.length===0)return;
  S.clipboard=S.sels.map(g=>g.cloneNode(true));
  toast('Copiado ('+S.clipboard.length+')','ok');
}

function clipPaste(){
  if(S.clipboard.length===0)return;
  desel();
  const ns=[];
  S.clipboard.forEach(clone=>{
    const g=clone.cloneNode(true);
    const p=gPos(g);sPos(g,p.x+20,p.y+20);
    insertByLayer(g);ns.push(g);
  });
  S.sels=ns;
  drawSelHandles();
  if(ns.length===1)showProps(ns[0]);else showMultiProps();
  $('propsec').style.display='block';
  pushH();updAutoDims();
  toast('Pegado ('+ns.length+')','ok');
}

// ═══════════════════════════════════════════════════════════════
// DOUBLE CLICK INLINE EDIT
// ═══════════════════════════════════════════════════════════════
function onDbl(e){
  if(S.tool!=='select')return;
  const blk=findBlock(e.target);
  if(!blk)return;
  const label=blk.querySelector('.room-label');
  if(!label)return;

  const pos=gPos(blk);
  const tx=pos.x+(+label.getAttribute('x')||0);
  const ty=pos.y+(+label.getAttribute('y')||0);
  const fs=+label.getAttribute('font-size')||14;

  const cr=canvas.getBoundingClientRect();
  const sx=tx*S.zoom+S.px+cr.left;
  const sy=ty*S.zoom+S.py+cr.top;
  const zfs=Math.max(12,fs*S.zoom);

  const inp=document.createElement('input');
  inp.type='text';inp.value=label.textContent;
  inp.className='inline-edit';
  inp.style.left=(sx-75)+'px';inp.style.top=(sy-zfs/2-4)+'px';
  inp.style.width='150px';inp.style.fontSize=zfs+'px';
  document.body.appendChild(inp);
  label.style.opacity='0';

  const finish=()=>{
    const val=inp.value.trim();
    if(val){label.textContent=val;blk.setAttribute('data-name',val)}
    label.style.opacity='1';inp.remove();pushH();
    if(S.sels.includes(blk)&&S.sels.length===1)showProps(blk);
  };
  inp.addEventListener('blur',finish);
  inp.addEventListener('keydown',ev=>{
    if(ev.key==='Enter'){ev.preventDefault();inp.blur()}
    if(ev.key==='Escape'){inp.value=label.textContent;inp.blur()}
    ev.stopPropagation();
  });
  setTimeout(()=>{inp.focus();inp.select()},30);
}

// ═══════════════════════════════════════════════════════════════
// PROPERTIES (multi-select aware)
// ═══════════════════════════════════════════════════════════════
function showProps(g){
  if(!g)return;
  const name=g.getAttribute('data-name')||g.getAttribute('data-type')||'Elemento';
  const type=g.getAttribute('data-type')||'g';
  $('ptitle').textContent=name;$('ptype').textContent=type;
  const rc=gRect(g);let h='';
  if(rc){
    const mw=px2mx(rc.w),mh=px2my(rc.h);
    h+='<div class="pg">';
    h+=pv('Ancho',mw.toFixed(2)+' m')+pv('Alto',mh.toFixed(2)+' m');
    const _pts=polyPoints(g);
    if(_pts){h+=pv('Area',(polyArea(_pts)/((S.WPx/S.WM)*(S.HPx/S.HM))).toFixed(2)+' m2')}
    else if(mw>.1&&mh>.1)h+=pv('Area',(mw*mh).toFixed(2)+' m2');
    h+=pv('Pos',px2mx(rc.x-S.OX).toFixed(1)+', '+px2my(rc.y-S.OY).toFixed(1)+' m');
    const rot=+g.getAttribute('data-rot')||0;
    const fh=+g.getAttribute('data-fliph')||0;
    const fv=+g.getAttribute('data-flipv')||0;
    if(rot||fh||fv){let tf=[];if(rot)tf.push(rot+'°');if(fh)tf.push('↔');if(fv)tf.push('↕');h+=pv('Transform',tf.join(' '))}
    h+='</div><div style="height:8px"></div>';
    const mr=gMainRect(g),pos=gPos(g);
    if(mr){
      h+='<div class="pg">';
      h+=pinp('X',pos.x,v=>{sPos(g,v,gPos(g).y);refreshS()});
      h+=pinp('Y',pos.y,v=>{sPos(g,gPos(g).x,v);refreshS()});
      h+=pinp('W',+mr.getAttribute('width'),v=>{const oldW=+mr.getAttribute('width');mr.setAttribute('width',v);const pp=polyPoints(g);if(pp&&oldW>0){const sx=v/oldW;g.setAttribute('data-poly',pp.map(([px,py])=>[Math.round(px*sx),py].join(',')).join(' '))}centerLabels(g);refreshS()});
      h+=pinp('H',+mr.getAttribute('height'),v=>{const oldH=+mr.getAttribute('height');mr.setAttribute('height',v);const pp=polyPoints(g);if(pp&&oldH>0){const sy=v/oldH;g.setAttribute('data-poly',pp.map(([px,py])=>[px,Math.round(py*sy)].join(',')).join(' '))}centerLabels(g);refreshS()});
      h+='</div><div style="height:8px"></div>';
      const polyEl=g.querySelector('.room-poly');
      h+=pcol('Relleno',(polyEl?polyEl.getAttribute('fill'):mr.getAttribute('fill'))||'#fff',v=>{const pe=g.querySelector('.room-poly');if(pe)pe.setAttribute('fill',v);else mr.setAttribute('fill',v)});
    }
    h+='<div style="height:8px"></div>';
    h+=ptxt('Nombre',name,v=>{g.setAttribute('data-name',v);const lb=g.querySelector('.room-label');if(lb)lb.textContent=v;$('ptitle').textContent=v;pushH()});
    if(type==='room'||type==='label'){
      const curFs=g.getAttribute('data-font-size')||'';
      const curFf=g.getAttribute('data-font-family')||'Inter,Arial,sans-serif';
      const curTp=g.getAttribute('data-text-pos')||'center';
      const lbl=g.querySelector('.room-label');
      const defFs=lbl?Math.round(+lbl.getAttribute('font-size')):14;
      h+='<div style="height:8px"></div><div class="psh"><h3>Texto</h3></div>';
      h+=pinp('Tamano',curFs?+curFs:defFs,v=>{g.setAttribute('data-font-size',v);applyTextStyle(g)});
      h+=pselect('Fuente',[{v:'Inter,Arial,sans-serif',n:'Inter'},{v:'Georgia,serif',n:'Georgia'},{v:'Courier New,monospace',n:'Courier'},{v:'Arial,sans-serif',n:'Arial'}],curFf,v=>{g.setAttribute('data-font-family',v);applyTextStyle(g)});
      if(type==='room')h+=pselect('Posicion',[{v:'top',n:'Arriba'},{v:'center',n:'Centro'},{v:'bottom',n:'Abajo'}],curTp,v=>{g.setAttribute('data-text-pos',v);applyTextStyle(g)});
    }
    if(type==='room'){
      const curPoly=g.getAttribute('data-poly');
      let curShape='rect';
      if(curPoly){const mr2=gMainRect(g);const w2=mr2?+mr2.getAttribute('width'):1,h2=mr2?+mr2.getAttribute('height'):1;
        for(const[k,v]of Object.entries(SHAPE_PRESETS)){if(!v)continue;const testPts=v.map(([px,py])=>[Math.round(px*w2),Math.round(py*h2)]);const testStr=testPts.map(p=>p.join(',')).join(' ');if(testStr===curPoly.trim()){curShape=k;break}}}
      h+='<div style="height:8px"></div><div class="psh"><h3>Forma</h3></div>';
      h+='<div style="display:flex;gap:3px;flex-wrap:wrap">';
      Object.keys(SHAPE_PRESETS).forEach(k=>{
        const active=k===curShape;
        h+=`<button class="abtn" style="width:36px;height:28px;font-size:10px;font-weight:600;${active?'background:var(--acc);color:#fff':''}" onclick="setRoomShape(S.sels[0],'${k}')">${SHAPE_LABELS[k]||k}</button>`;
      });
      h+='</div>';
    }
  }
  $('pcontent').innerHTML=h;
}

function showMultiProps(){
  $('ptitle').textContent=S.sels.length+' elementos';
  $('ptype').textContent='multi';
  let totalArea=0;
  S.sels.forEach(g=>{const rc=gRect(g);if(rc)totalArea+=px2mx(rc.w)*px2my(rc.h)});
  $('pcontent').innerHTML=`<div class="pg">${pv('Elementos',S.sels.length)}${pv('Area total',totalArea.toFixed(2)+' m2')}</div>`;
  $('alignsec').style.display='block';
}

function pv(l,v){return`<div class="pi"><div class="pl">${l}</div><div class="pv">${v}</div></div>`}
function pinp(l,v,fn){const id='_'+Math.random().toString(36).substr(2,5);setTimeout(()=>{const i=$(id);if(i)i.addEventListener('change',e=>{fn(+e.target.value);pushH();updAutoDims()})});return`<div class="pi"><div class="pl">${l}</div><input id="${id}" class="pin" type="number" value="${Math.round(v)}" step="5"></div>`}
function ptxt(l,v,fn){const id='_'+Math.random().toString(36).substr(2,5);setTimeout(()=>{const i=$(id);if(i)i.addEventListener('change',e=>{fn(e.target.value)})});return`<div class="pi f"><div class="pl">${l}</div><input id="${id}" class="pin" type="text" value="${v}"></div>`}
function pcol(l,v,fn){const id='_'+Math.random().toString(36).substr(2,5);if(!v||v==='none'||!v.startsWith('#'))v='#ffffff';setTimeout(()=>{const i=$(id);if(i){i.addEventListener('input',e=>fn(e.target.value));i.addEventListener('change',()=>pushH())}});return`<div class="pi f"><div class="pl">${l}</div><div class="pcr"><div class="pcs" style="background:${v}"><input id="${id}" type="color" value="${v}"></div><span style="font-size:11px;color:var(--txt3);font-family:monospace">${v}</span></div></div>`}
function pselect(l,opts,cur,fn){const id='_'+Math.random().toString(36).substr(2,5);setTimeout(()=>{const el=$(id);if(el)el.addEventListener('change',e=>{fn(e.target.value);pushH();updAutoDims()})});let h=`<div class="pi f"><div class="pl">${l}</div><select id="${id}" class="pin">`;opts.forEach(o=>{h+=`<option value="${o.v}"${o.v===cur?' selected':''}>${o.n}</option>`});return h+'</select></div>'}
function applyTextStyle(g){
  const lbl=g.querySelector('.room-label');if(!lbl)return;
  const mr=gMainRect(g);
  const w=mr?+mr.getAttribute('width'):0,ht=mr?+mr.getAttribute('height'):0;
  const fs=g.getAttribute('data-font-size');
  const ff=g.getAttribute('data-font-family');
  const tp=g.getAttribute('data-text-pos')||'center';
  if(fs)lbl.setAttribute('font-size',fs);
  if(ff){lbl.setAttribute('font-family',ff);const sub=g.querySelector('.room-sub');if(sub)sub.setAttribute('font-family',ff)}
  const sub=g.querySelector('.room-sub');
  let ly;
  if(tp==='top')ly=20;
  else if(tp==='bottom')ly=ht-10;
  else ly=ht/2+(sub?-4:4);
  lbl.setAttribute('y',ly);
  if(sub)sub.setAttribute('y',ly+18);
  refreshS();
}
function refreshS(){if(S.sels.length===1){drawSelHandles();showProps(S.sels[0])}}

// ═══════════════════════════════════════════════════════════════
// CONTEXT MENU (multi-select aware)
// ═══════════════════════════════════════════════════════════════
function delSel(){
  if(S.sels.length===0)return;
  S.sels.forEach(g=>g.remove());desel();pushH();updAutoDims();toast('Eliminado','w');
}
function dup(){
  if(S.sels.length===0)return;
  const ns=[];
  S.sels.forEach(g=>{const c=g.cloneNode(true);const p=gPos(g);sPos(c,p.x+20,p.y+20);insertByLayer(c);ns.push(c)});
  S.sels=ns;drawSelHandles();pushH();updAutoDims();ctx.classList.remove('vis');
  if(ns.length===1)showProps(ns[0]);else showMultiProps();
  $('propsec').style.display='block';toast('Duplicado','ok');
}
function front(){S.sels.forEach(g=>blocksG.appendChild(g));ctx.classList.remove('vis');pushH()}
function back(){S.sels.forEach(g=>blocksG.insertBefore(g,blocksG.firstChild));ctx.classList.remove('vis');pushH()}

// ═══════════════════════════════════════════════════════════════
// FURNITURE LIBRARY (Drag & Drop)
// ═══════════════════════════════════════════════════════════════
const FURN_ITEMS=[
  // Sala
  {n:'Sofa',w:120,h:40,f:'#f0ece8',cat:'Sala',icon:'<rect x="2" y="2" width="36" height="6" rx="1" fill="none"/><rect x="2" y="2" width="3" height="24" rx="1" fill="none"/><rect x="35" y="2" width="3" height="24" rx="1" fill="none"/>'},
  {n:'Mesa',w:80,h:60,f:'#f0ece8',cat:'Sala',icon:'<ellipse cx="20" cy="15" rx="14" ry="10" fill="none"/>'},
  {n:'Silla',w:35,h:35,f:'#f0ece8',cat:'Sala',icon:'<rect x="10" y="8" width="20" height="18" rx="1" fill="none"/><rect x="8" y="2" width="24" height="5" rx="1" fill="none"/>'},
  {n:'TV',w:80,h:8,f:'#e8e8e8',cat:'Sala',icon:'<rect x="3" y="8" width="34" height="10" rx="1" fill="none"/><rect x="16" y="18" width="8" height="6" rx="1" fill="none"/>'},
  {n:'Chimenea',w:80,h:30,f:'#f0ece8',cat:'Sala',icon:'<rect x="4" y="4" width="32" height="22" rx="1" fill="none"/><path d="M10,26 L10,12 Q10,8 20,8 Q30,8 30,12 L30,26" fill="none"/>'},
  // Dormitorio
  {n:'Cama',w:100,h:130,f:'#f0ece8',cat:'Dormitorio',icon:'<rect x="2" y="2" width="36" height="26" rx="1" fill="none"/><rect x="4" y="3" width="14" height="6" rx="2" fill="none"/><rect x="22" y="3" width="14" height="6" rx="2" fill="none"/><line x1="2" y1="12" x2="38" y2="12"/>'},
  {n:'Armario',w:100,h:45,f:'#ede9e5',cat:'Dormitorio',icon:'<rect x="2" y="5" width="36" height="20" rx="1" fill="none"/><line x1="20" y1="5" x2="20" y2="25"/><circle cx="17" cy="15" r="1.5" fill="currentColor"/><circle cx="23" cy="15" r="1.5" fill="currentColor"/>'},
  {n:'Mesa de noche',w:35,h:35,f:'#f0ece8',cat:'Dormitorio',icon:'<rect x="8" y="5" width="24" height="20" rx="1" fill="none"/><line x1="8" y1="15" x2="32" y2="15"/><circle cx="20" cy="10" r="1" fill="currentColor"/>'},
  {n:'Escritorio',w:100,h:55,f:'#f0ece8',cat:'Dormitorio',icon:'<rect x="2" y="4" width="36" height="22" rx="1" fill="none"/><rect x="4" y="14" width="16" height="10" rx="1" fill="none"/>'},
  // Baño
  {n:'Inodoro',w:35,h:45,f:'#fff',cat:'Baño',icon:'<rect x="10" y="2" width="20" height="10" rx="1" fill="none"/><path d="M10,26 L10,13 Q10,10 20,10 Q30,10 30,13 L30,26" fill="none"/>'},
  {n:'Ducha',w:60,h:60,f:'#fff',cat:'Baño',icon:'<rect x="4" y="4" width="22" height="22" rx="1" fill="none"/><line x1="4" y1="4" x2="26" y2="26"/><line x1="26" y1="4" x2="4" y2="26"/>'},
  {n:'Lavabo',w:40,h:30,f:'#fff',cat:'Baño',icon:'<path d="M8,5 L32,5 L32,12 Q32,24 20,24 Q8,24 8,12 Z" fill="none"/><circle cx="20" cy="14" r="2" fill="none"/>'},
  {n:'Bañera',w:60,h:130,f:'#fff',cat:'Baño',icon:'<rect x="4" y="2" width="32" height="26" rx="8" fill="none"/><ellipse cx="20" cy="15" rx="12" ry="9" fill="none"/>'},
  // Cocina
  {n:'Estufa',w:50,h:50,f:'#fff',cat:'Cocina',icon:'<rect x="4" y="4" width="32" height="22" rx="1" fill="none"/><circle cx="14" cy="10" r="4" fill="none"/><circle cx="26" cy="10" r="4" fill="none"/><circle cx="14" cy="20" r="4" fill="none"/><circle cx="26" cy="20" r="4" fill="none"/>'},
  {n:'Nevera',w:45,h:55,f:'#fff',cat:'Cocina',icon:'<rect x="8" y="2" width="24" height="26" rx="1" fill="none"/><line x1="8" y1="10" x2="32" y2="10"/><line x1="28" y1="4" x2="28" y2="8"/><line x1="28" y1="13" x2="28" y2="25"/>'},
  {n:'Lavadora',w:45,h:45,f:'#f5f5f5',cat:'Cocina',icon:'<rect x="4" y="4" width="32" height="22" rx="1" fill="none"/><circle cx="20" cy="16" r="7" fill="none"/><circle cx="20" cy="16" r="4" fill="none"/>'},
  // Simbolos
  {n:'Escalera',w:80,h:120,f:'#fff',cat:'Simbolos',icon:'<rect x="4" y="2" width="32" height="26" rx="1" fill="none"/><line x1="4" y1="6" x2="36" y2="6"/><line x1="4" y1="10" x2="36" y2="10"/><line x1="4" y1="14" x2="36" y2="14"/><line x1="4" y1="18" x2="36" y2="18"/><line x1="4" y1="22" x2="36" y2="22"/><path d="M20,22 L20,6 M16,10 L20,6 L24,10" fill="none"/>'},
  {n:'Columna',w:20,h:20,f:'#333',cat:'Simbolos',icon:'<rect x="10" y="5" width="20" height="20" fill="currentColor" opacity=".4"/>'},
  {n:'Flecha Norte',w:30,h:40,f:'none',cat:'Simbolos',icon:'<path d="M20,3 L28,18 L20,14 L12,18 Z" fill="currentColor" opacity=".3"/><text x="20" y="27" text-anchor="middle" font-size="8" fill="currentColor" font-weight="bold">N</text>'},
  // Personalizado
  {n:'Otro...',w:60,h:40,f:'#f0ece8',cat:'Otro',custom:true,icon:'<rect x="6" y="4" width="28" height="22" rx="2" fill="none" stroke-dasharray="3,2"/><text x="20" y="18" text-anchor="middle" font-size="7" fill="currentColor">+</text>'},
];

function addCustomFurn(dropX,dropY){
  const name=prompt('Nombre del mueble:');
  if(!name||!name.trim())return;
  const nm=name.trim();
  const x=dropX!=null?dropX:350,y=dropY!=null?dropY:450;
  const g=mkFurn(x,y,60,40,'#f0ece8',nm);
  insertByLayer(g);sel(g);setT('select');pushH();updAutoDims();toast(nm+' agregado','ok');
}

function buildLib(){
  const box=$('furnlib');box.innerHTML='';
  const cats={};
  FURN_ITEMS.forEach(it=>{if(!cats[it.cat])cats[it.cat]=[];cats[it.cat].push(it)});
  for(const[cat,items]of Object.entries(cats)){
    const hdr=document.createElement('div');hdr.className='cat-hdr';
    hdr.innerHTML=`<span>${cat}</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>`;
    const grid=document.createElement('div');grid.className='cat-grid';
    hdr.addEventListener('click',()=>{grid.classList.toggle('cat-hide');hdr.classList.toggle('cat-closed')});
    box.appendChild(hdr);
    items.forEach(it=>{
      const d=document.createElement('div');d.className='li';
      d.setAttribute('draggable','true');
      d.innerHTML=`<svg viewBox="0 0 40 30" fill="none" stroke="currentColor" stroke-width="1.5">${it.icon}</svg><span>${it.n}</span>`;
      if(it.custom){
        d.addEventListener('click',()=>{addCustomFurn()});
        d.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain',JSON.stringify({n:'_custom_',w:it.w,h:it.h,f:it.f}));
          e.dataTransfer.effectAllowed='copy';
        });
      }else{
        d.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain',JSON.stringify({n:it.n,w:it.w,h:it.h,f:it.f}));
          e.dataTransfer.effectAllowed='copy';
        });
        d.addEventListener('click',()=>{
          const g=mkFurn(350,450,it.w,it.h,it.f,it.n);
          insertByLayer(g);sel(g);setT('select');pushH();updAutoDims();toast(it.n+' agregado','ok');
        });
      }
      grid.appendChild(d);
    });
    box.appendChild(grid);
  }
}

function onDrop(e){
  e.preventDefault();
  try{
    const data=JSON.parse(e.dataTransfer.getData('text/plain'));
    if(!data.n||!data.w)return;
    const p=c2s(e.clientX,e.clientY);
    if(data.n==='_custom_'){
      addCustomFurn(sn(p.x-data.w/2),sn(p.y-data.h/2));
      return;
    }
    const g=mkFurn(sn(p.x-data.w/2),sn(p.y-data.h/2),data.w,data.h,data.f,data.n);
    insertByLayer(g);sel(g);setT('select');pushH();updAutoDims();
    toast(data.n+' agregado','ok');
  }catch(err){}
}

function buildColors(){
  const cols=['#f0f3f5','#eaecf0','#e3f2fd','#e0f7fa','#f3e5f5','#fffde7','#ffebee','#e8f5e9','#fff3e0','#fce4ec','#64b5f6','#e53935','#ffca28','#bdbdbd','#8d6e63','#2d3436'];
  const box=$('qcolors');
  cols.forEach(c=>{
    const d=document.createElement('div');d.className='qcd';d.style.background=c;d.title=c;
    d.addEventListener('click',()=>{
      S.sels.forEach(g=>{const pe=g.querySelector('.room-poly');if(pe)pe.setAttribute('fill',c);else{const mr=gMainRect(g);if(mr)mr.setAttribute('fill',c)}});
      pushH();if(S.sels.length===1)showProps(S.sels[0]);
    });
    box.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════════════════
// GRID
// ═══════════════════════════════════════════════════════════════
function togGrid(){S.gridOn=$('gridck').checked;gridG.style.display=S.gridOn?'block':'none';if(S.gridOn)drawGrid()}
function drawGrid(){
  gridG.innerHTML='';if(!S.gridOn)return;
  const sMaj=1,sMin=.5;
  for(let x=S.OX;x<=S.OX+S.WPx;x+=m2px(sMin)){const l=ce('line');l.setAttribute('x1',x);l.setAttribute('y1',S.OY);l.setAttribute('x2',x);l.setAttribute('y2',S.OY+S.HPx);l.setAttribute('class','grid-min');gridG.appendChild(l)}
  for(let y=S.OY;y<=S.OY+S.HPx;y+=m2py(sMin)){const l=ce('line');l.setAttribute('x1',S.OX);l.setAttribute('y1',y);l.setAttribute('x2',S.OX+S.WPx);l.setAttribute('y2',y);l.setAttribute('class','grid-min');gridG.appendChild(l)}
  for(let x=S.OX;x<=S.OX+S.WPx;x+=m2px(sMaj)){const l=ce('line');l.setAttribute('x1',x);l.setAttribute('y1',S.OY);l.setAttribute('x2',x);l.setAttribute('y2',S.OY+S.HPx);l.setAttribute('class','grid-maj');gridG.appendChild(l)}
  for(let y=S.OY;y<=S.OY+S.HPx;y+=m2py(sMaj)){const l=ce('line');l.setAttribute('x1',S.OX);l.setAttribute('y1',y);l.setAttribute('x2',S.OX+S.WPx);l.setAttribute('y2',y);l.setAttribute('class','grid-maj');gridG.appendChild(l)}
  let m=0;for(let x=S.OX;x<=S.OX+S.WPx;x+=m2px(sMaj)){const t=ce('text');t.setAttribute('x',x);t.setAttribute('y',S.OY-3);t.setAttribute('class','grid-lbl');t.setAttribute('text-anchor','middle');t.textContent=m+'m';gridG.appendChild(t);m+=sMaj}
  m=0;for(let y=S.OY;y<=S.OY+S.HPx;y+=m2py(sMaj)){const t=ce('text');t.setAttribute('x',S.OX-4);t.setAttribute('y',y+3);t.setAttribute('class','grid-lbl');t.setAttribute('text-anchor','end');t.textContent=m+'m';gridG.appendChild(t);m+=sMaj}
}

// ═══════════════════════════════════════════════════════════════
// TOTAL AREA + SCALE BAR
// ═══════════════════════════════════════════════════════════════
function calcTotalArea(){
  const box=$('areacontent');if(!box||!blocksG)return;
  let total=0;const rooms=[];
  blocksG.querySelectorAll('[data-type="room"]').forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    const pts=polyPoints(g);
    let area;
    if(pts){area=polyArea(pts)/((S.WPx/S.WM)*(S.HPx/S.HM))}
    else{const mw=px2mx(rc.w),mh=px2my(rc.h);area=mw*mh}
    total+=area;rooms.push({name:g.getAttribute('data-name')||'?',area});
  });
  let h='<div style="font-size:11px;color:var(--txt2);line-height:1.8">';
  rooms.forEach(r=>{h+=`<div style="display:flex;justify-content:space-between"><span>${r.name}</span><span style="color:var(--acc2);font-weight:600">${r.area.toFixed(1)} m\u00b2</span></div>`});
  h+=`<div style="display:flex;justify-content:space-between;border-top:1px solid var(--brd);margin-top:4px;padding-top:4px;font-weight:700;color:var(--txt)"><span>Total</span><span style="color:var(--grn)">${total.toFixed(2)} m\u00b2</span></div></div>`;
  box.innerHTML=h;
}

function drawScaleBar(){
  if(!scaleG)return;scaleG.innerHTML='';if(!S.scaleOn)return;
  const barY=955,barX=S.OX,barH=7;
  const totalM=Math.min(5,Math.floor(S.WM));
  const segW=m2px(1);
  for(let i=0;i<totalM;i++){
    const r=ce('rect');sa(r,{x:barX+i*segW,y:barY,width:segW,height:barH,fill:i%2===0?'#333':'#fff',stroke:'#333','stroke-width':'.5'});scaleG.appendChild(r);
  }
  for(let i=0;i<=totalM;i++){
    const t=ce('text');sa(t,{x:barX+i*segW,y:barY+barH+11,'text-anchor':'middle','font-size':'8',fill:'#666','font-family':'Inter,Arial,sans-serif','font-weight':'500'});t.textContent=i+'m';scaleG.appendChild(t);
  }
  const cap1=ce('line');sa(cap1,{x1:barX,y1:barY-2,x2:barX,y2:barY+barH+2,stroke:'#333','stroke-width':'.8'});scaleG.appendChild(cap1);
  const cap2=ce('line');sa(cap2,{x1:barX+totalM*segW,y1:barY-2,x2:barX+totalM*segW,y2:barY+barH+2,stroke:'#333','stroke-width':'.8'});scaleG.appendChild(cap2);
  const lbl=ce('text');sa(lbl,{x:barX+totalM*segW+12,y:barY+barH/2+3,'text-anchor':'start','font-size':'7',fill:'#999','font-family':'Inter,Arial,sans-serif','font-weight':'700','letter-spacing':'1'});lbl.textContent='ESCALA 1:'+Math.round(S.WPx/S.WM);scaleG.appendChild(lbl);
}

function togScale(){S.scaleOn=$('scaleck').checked;drawScaleBar()}

// ═══════════════════════════════════════════════════════════════
// LAYERS
// ═══════════════════════════════════════════════════════════════
const LAYERS=[
  {id:'rooms',label:'Habitaciones',types:['room','boundary'],on:true},
  {id:'walls',label:'Paredes',types:['wall'],on:true},
  {id:'doorwin',label:'Puertas / Ventanas',types:['door','window'],on:true},
  {id:'furn',label:'Muebles',types:['furniture'],on:true},
  {id:'labels',label:'Textos',types:['label'],on:true},
  {id:'dims',label:'Cotas',special:'dimG',on:true},
  {id:'scale',label:'Escala',special:'scaleG',on:true},
];

function buildLayers(){
  const box=$('layercontent');if(!box)return;box.innerHTML='';
  LAYERS.forEach(l=>{
    const row=document.createElement('div');row.className='layer-row';
    const lbl=document.createElement('label');lbl.className='tck';
    const inp=document.createElement('input');inp.type='checkbox';inp.checked=l.on;
    const ck=document.createElement('span');ck.className='ck';
    const txt=document.createTextNode(l.label);
    inp.addEventListener('change',()=>{l.on=inp.checked;applyLayers()});
    lbl.appendChild(inp);lbl.appendChild(ck);lbl.appendChild(txt);
    row.appendChild(lbl);box.appendChild(row);
  });
}

function applyLayers(){
  LAYERS.forEach(l=>{
    if(l.special){
      const g=svg.querySelector('#'+l.special);
      if(g)g.style.display=l.on?'':'none';
    }else{
      blocksG.querySelectorAll('[data-type]').forEach(g=>{
        if(l.types.includes(g.getAttribute('data-type')))g.style.display=l.on?'':'none';
      });
    }
  });
}

// ═══════════════════════════════════════════════════════════════
// UNDO/REDO
// ═══════════════════════════════════════════════════════════════
function pushH(){const c=blocksG.innerHTML;S.hist=S.hist.slice(0,S.hi+1);S.hist.push(c);S.hi=S.hist.length-1;if(S.hist.length>60){S.hist.shift();S.hi--}S.dirty=true;updProjIndicator()}
function undo(){if(S.hi<=0)return;S.hi--;restoreH();toast('Deshacer')}
function redo(){if(S.hi>=S.hist.length-1)return;S.hi++;restoreH();toast('Rehacer')}
function restoreH(){desel();blocksG.innerHTML=S.hist[S.hi];sortBlocksZ();updAutoDims();applyLayers()}

// ═══════════════════════════════════════════════════════════════
// FILE I/O
// ═══════════════════════════════════════════════════════════════
function loadFile(){$('finput').click()}
function onFile(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const d=new DOMParser().parseFromString(ev.target.result,'image/svg+xml');const s=d.querySelector('svg');if(!s){toast('SVG invalido','w');return}wrap.innerHTML='';wrap.appendChild(document.importNode(s,true));svg=wrap.querySelector('svg');const vb=svg.getAttribute('viewBox');if(vb){const p=vb.split(/[\s,]+/);svg.style.width=p[2]+'px';svg.style.height=p[3]+'px'}fit();toast('Cargado: '+f.name,'ok')};r.readAsText(f);e.target.value=''}
function expSVG(){const c=svg.cloneNode(true);['#selG','#liveG','#snapG','#gridG'].forEach(s=>{const e=c.querySelector(s);if(e)e.remove()});const d=new XMLSerializer().serializeToString(c);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([d],{type:'image/svg+xml'}));a.download='plano.svg';a.click();toast('SVG exportado','ok')}
function expPNG(){const c=svg.cloneNode(true);['#selG','#liveG','#snapG','#gridG'].forEach(s=>{const e=c.querySelector(s);if(e)e.remove()});const d=new XMLSerializer().serializeToString(c);const cv=document.createElement('canvas');cv.width=1600;cv.height=2000;const cx=cv.getContext('2d');const img=new Image();img.onload=()=>{cx.fillStyle='#f0ede6';cx.fillRect(0,0,1600,2000);cx.drawImage(img,0,0,1600,2000);const a=document.createElement('a');a.href=cv.toDataURL('image/png');a.download='plano.png';a.click();toast('PNG exportado','ok')};img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(d)))}
function expPDF(){
  const s=+prompt('Escala de impresion:\n\n  50 = escala 1:50 (detalles, grande)\n  100 = escala 1:100 (vista general)\n\nIngrese el denominador:','100');
  if(!s||s<=0)return;
  const c=svg.cloneNode(true);
  ['#selG','#liveG','#snapG','#gridG'].forEach(sel=>{const e=c.querySelector(sel);if(e)e.remove()});
  const svgStr=new XMLSerializer().serializeToString(c);
  // Calculate print dimensions in mm (real meters * 1000 / scale)
  const svgWMM=((800/S.WPx)*S.WM*1000/s).toFixed(1);
  const svgHMM=((1000/S.HPx)*S.HM*1000/s).toFixed(1);
  // Build area table rows
  let rows='',total=0;
  blocksG.querySelectorAll('[data-type="room"]').forEach(g=>{
    const rc=gRect(g);if(!rc)return;
    const mw=px2mx(rc.w),mh=px2my(rc.h),area=mw*mh;total+=area;
    rows+=`<tr><td>${g.getAttribute('data-name')||'?'}</td><td style="text-align:right">${mw.toFixed(2)} x ${mh.toFixed(2)}</td><td style="text-align:right;font-weight:600">${area.toFixed(2)} m\u00b2</td></tr>`;
  });
  const win=window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Plano - Escala 1:${s}</title>
<style>
@page{size:auto;margin:10mm}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Helvetica Neue',Arial,sans-serif;color:#333;padding:6mm}
.hdr{text-align:center;margin-bottom:5mm;border-bottom:2px solid #333;padding-bottom:4mm}
.hdr h1{font-size:15pt;font-weight:700;margin-bottom:1mm;letter-spacing:-.3px}
.hdr p{font-size:10pt;color:#666}
.meta{display:flex;justify-content:space-between;font-size:8pt;color:#888;margin-bottom:3mm;padding:0 2mm}
.plan{width:${svgWMM}mm;margin:3mm auto;overflow:visible}
.plan svg{width:100%;height:auto;display:block}
table.tbl{margin:5mm auto;border-collapse:collapse;font-size:9pt;min-width:50%}
.tbl th,.tbl td{border:1px solid #ccc;padding:1.5mm 4mm}
.tbl th{background:#f0f0f0;font-weight:700;text-align:left;font-size:8pt;text-transform:uppercase;letter-spacing:.5px}
.tbl tfoot td{font-weight:700;border-top:2px solid #333;background:#fafafa}
.ft{text-align:center;margin-top:5mm;font-size:7pt;color:#bbb;border-top:1px solid #eee;padding-top:2mm}
@media screen{body{max-width:850px;margin:0 auto;padding:20px}.plan{border:1px solid #ddd;padding:5mm;background:#fff}}
</style></head><body>
<div class="hdr"><h1>Plano Arquitectonico</h1><p>Area total: ${total.toFixed(2)} m\u00b2 &mdash; Escala 1:${s}</p></div>
<div class="meta"><span>Fecha: ${new Date().toLocaleDateString()}</span><span>Medidas: ${S.WM}m x ${S.HM}m</span><span>1 cm en papel = ${(s/100).toFixed(2)} m reales</span></div>
<div class="plan">${svgStr}</div>
<table class="tbl"><thead><tr><th>Ambiente</th><th>Dimensiones</th><th>Area</th></tr></thead><tbody>${rows}</tbody>
<tfoot><tr><td colspan="2">Total</td><td style="text-align:right">${total.toFixed(2)} m\u00b2</td></tr></tfoot></table>
<div class="ft">Generado por ArquiPlan &bull; ${new Date().toLocaleDateString()}</div>
<script>setTimeout(function(){window.print()},600)<\/script>
</body></html>`);
  win.document.close();
  toast('PDF listo para imprimir','ok');
}
// save/loadSaved/resetPlan removed — replaced by project system

// ═══════════════════════════════════════════════════════════════
// MODAL / TOAST / STATUS
// ═══════════════════════════════════════════════════════════════
function showModal(t,d,cb){$('mtitle').textContent=t;$('minput').value=d;S.mcb=cb;$('modal').classList.add('vis');setTimeout(()=>$('minput').focus(),50)}
function modalNo(){$('modal').classList.remove('vis');S.mcb=null}
function modalOk(){const v=$('minput').value;if(S.mcb)S.mcb(v);modalNo()}
function toast(m,t=''){const d=document.createElement('div');d.className='toast '+(t==='ok'?'ok':t==='w'?'w':'');d.textContent=m;$('toasts').appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transform='translateY(8px)';d.style.transition='.25s';setTimeout(()=>d.remove(),250)},1800)}
function updPos(p){$('spos').textContent=`X: ${px2mx(p.x-S.OX).toFixed(2)}m   Y: ${px2my(p.y-S.OY).toFixed(2)}m`}

// ═══════════════════════════════════════════════════════════════
// LIGHT/DARK MODE
// ═══════════════════════════════════════════════════════════════
function toggleTheme(){
  document.body.classList.toggle('light');
  S.lightMode=document.body.classList.contains('light');
  localStorage.setItem('ap-theme',S.lightMode?'light':'dark');
  const btn=$('themeBtn');
  if(btn)btn.innerHTML=S.lightMode?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';
  drawRulers();
  toast(S.lightMode?'Modo claro':'Modo oscuro','ok');
}
function loadTheme(){
  const t=localStorage.getItem('ap-theme');
  if(t==='light'){document.body.classList.add('light');S.lightMode=true;
    const btn=$('themeBtn');
    if(btn)btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
  }
}

// ═══════════════════════════════════════════════════════════════
// RULERS
// ═══════════════════════════════════════════════════════════════
function togRulers(){S.rulersOn=$('rulerck').checked;$('rulerH').style.display=S.rulersOn?'':'none';$('rulerV').style.display=S.rulersOn?'':'none';$('rulerC').style.display=S.rulersOn?'':'none';if(S.rulersOn)drawRulers()}
function drawRulers(){if(!S.rulersOn)return;drawRulerH();drawRulerV()}
function drawRulerH(){
  const el=$('rulerH'),cv=$('rHc');if(!el||!cv)return;
  const w=el.clientWidth,h=22,dpr=window.devicePixelRatio||1;
  cv.width=w*dpr;cv.height=h*dpr;cv.style.width=w+'px';cv.style.height=h+'px';
  const c=cv.getContext('2d');c.scale(dpr,dpr);
  const light=S.lightMode;
  c.fillStyle=light?'#fff':'#1a1a2e';c.fillRect(0,0,w,h);
  c.strokeStyle=light?'#ccc':'#2d2d50';c.fillStyle=light?'#888':'#667';
  c.font='8px Inter,sans-serif';c.textBaseline='top';
  for(let m=-2;m<S.WM+5;m+=0.25){
    const svgX=S.OX+m2px(m),sx=svgX*S.zoom+S.px;
    if(sx<-20||sx>w+20)continue;
    const major=Math.abs(m%1)<.01,mid=Math.abs(m%0.5)<.01&&!major;
    c.beginPath();c.moveTo(sx,major?4:mid?12:16);c.lineTo(sx,h);c.lineWidth=major?1:0.5;c.stroke();
    if(major)c.fillText(m.toFixed(0)+'m',sx+2,2);
  }
}
function drawRulerV(){
  const el=$('rulerV'),cv=$('rVc');if(!el||!cv)return;
  const w=22,h=el.clientHeight,dpr=window.devicePixelRatio||1;
  cv.width=w*dpr;cv.height=h*dpr;cv.style.width=w+'px';cv.style.height=h+'px';
  const c=cv.getContext('2d');c.scale(dpr,dpr);
  const light=S.lightMode;
  c.fillStyle=light?'#fff':'#1a1a2e';c.fillRect(0,0,w,h);
  c.strokeStyle=light?'#ccc':'#2d2d50';c.fillStyle=light?'#888':'#667';
  c.font='8px Inter,sans-serif';c.textBaseline='middle';
  for(let m=-2;m<S.HM+5;m+=0.25){
    const svgY=S.OY+m2py(m),sy=svgY*S.zoom+S.py-22;
    if(sy<-20||sy>h+20)continue;
    const major=Math.abs(m%1)<.01,mid=Math.abs(m%0.5)<.01&&!major;
    c.beginPath();c.moveTo(major?4:mid?12:16,sy);c.lineTo(w,sy);c.lineWidth=major?1:0.5;c.stroke();
    if(major){c.save();c.translate(9,sy+2);c.rotate(-Math.PI/2);c.fillText(m.toFixed(0)+'m',0,0);c.restore()}
  }
}

// ═══════════════════════════════════════════════════════════════
// BACKGROUND IMAGE
// ═══════════════════════════════════════════════════════════════
function importBgImage(){$('bginput').click()}
function onBgFile(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const dataUrl=ev.target.result;
    bgImgG.innerHTML='';
    const img=ce('image');
    img.setAttributeNS('http://www.w3.org/1999/xlink','href',dataUrl);
    sa(img,{x:S.OX,y:S.OY,width:S.WPx,height:S.HPx,opacity:S.bgOpacity,preserveAspectRatio:'xMidYMid meet'});
    bgImgG.appendChild(img);
    S.bgImgData=dataUrl;
    updBgControls();
    toast('Imagen de fondo cargada','ok');
  };
  reader.readAsDataURL(f);e.target.value='';
}
function setBgOpacity(v){
  S.bgOpacity=v;
  const img=bgImgG?bgImgG.querySelector('image'):null;
  if(img)img.setAttribute('opacity',v);
  const lbl=$('bgoplbl');if(lbl)lbl.textContent=Math.round(v*100)+'%';
}
function removeBgImage(){bgImgG.innerHTML='';S.bgImgData=null;updBgControls();toast('Imagen eliminada','w')}
function updBgControls(){
  const box=$('bgcontent');if(!box)return;
  if(S.bgImgData){
    box.innerHTML=`<div class="bg-ctrl"><span style="font-size:10px;color:var(--txt2)">Opacidad</span><input type="range" min="0.05" max="1" step="0.05" value="${S.bgOpacity}" oninput="setBgOpacity(+this.value)"><span id="bgoplbl">${Math.round(S.bgOpacity*100)}%</span></div><button class="tb" onclick="removeBgImage()" style="width:100%;justify-content:center;margin-top:4px;color:var(--red)">Eliminar fondo</button>`;
  }else{
    box.innerHTML='<div style="font-size:11px;color:var(--txt3);padding:4px 0">Sin imagen. Usa el boton "Fondo" para importar.</div>';
  }
}

// ═══════════════════════════════════════════════════════════════
// PROJECTS
// ═══════════════════════════════════════════════════════════════
const PROJ_KEY='ap-projects';
function getProjects(){try{return JSON.parse(localStorage.getItem(PROJ_KEY))||[]}catch{return[]}}
function updProjIndicator(){
  const el=$('projind');if(!el)return;
  if(S.currentProject){
    el.innerHTML=`<span class="pi-dot ${S.dirty?'dirty':'saved'}"></span><span class="pi-name">${S.currentProject}</span>`;
    el.style.display='flex';
  }else{
    el.innerHTML='<span class="pi-name" style="color:var(--txt3)">Sin proyecto</span>';
    el.style.display='flex';
  }
}
function getProjectData(){
  return {blocks:blocksG.innerHTML,wm:S.WM,hm:S.HM,bgImg:S.bgImgData||null,bgOp:S.bgOpacity};
}
function saveProjectByName(name){
  const projects=getProjects();
  const entry={name,data:getProjectData(),date:new Date().toISOString()};
  const idx=projects.findIndex(p=>p.name===name);
  if(idx>=0)projects[idx]=entry;else projects.push(entry);
  localStorage.setItem(PROJ_KEY,JSON.stringify(projects));
  S.currentProject=name;S.dirty=false;updProjIndicator();
}
function saveProject(){
  if(S.currentProject){
    saveProjectByName(S.currentProject);
    toast('Guardado','ok');
  }else{
    showSaveAsModal();
  }
}
function showSaveAsModal(){
  $('savename').value=S.currentProject||'Mi plano';
  $('savemodal').classList.add('vis');
  setTimeout(()=>{$('savename').focus();$('savename').select()},50);
}
function doSaveAs(){
  const name=$('savename').value.trim();
  if(!name){toast('Ingresa un nombre','w');return}
  saveProjectByName(name);
  $('savemodal').classList.remove('vis');
  toast('Proyecto "'+name+'" guardado','ok');
}
function toggleSaveDD(){$('savedd').classList.toggle('vis')}
function closeSaveDD(){$('savedd').classList.remove('vis')}
function exportProjectFile(){
  const name=S.currentProject||'plano';
  const payload={version:'1.0',name,date:new Date().toISOString(),data:getProjectData()};
  const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=name.replace(/[^a-zA-Z0-9_\- ]/g,'')+'.arquiplan.json';a.click();
  toast('Archivo exportado','ok');
}
function importProjectFile(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const payload=JSON.parse(ev.target.result);
      if(!payload.data||!payload.data.blocks){toast('Archivo invalido','w');return}
      let name=payload.name||f.name.replace(/\.json$/,'').replace(/\.arquiplan$/,'');
      const existing=getProjects();
      if(existing.find(p=>p.name===name))name+=' (2)';
      const entry={name,data:payload.data,date:payload.date||new Date().toISOString()};
      existing.push(entry);
      localStorage.setItem(PROJ_KEY,JSON.stringify(existing));
      loadProject(name);
      toast('Proyecto "'+name+'" importado','ok');
    }catch{toast('Error al leer archivo','w')}
  };
  reader.readAsText(f);e.target.value='';
}
function loadProject(name){
  const proj=getProjects().find(p=>p.name===name);if(!proj)return;
  buildPlan();blocksG.innerHTML=proj.data.blocks;sortBlocksZ();
  S.WM=proj.data.wm||8.5;S.HM=proj.data.hm||10.1;
  $('sw').value=S.WM;$('sh').value=S.HM;
  if(proj.data.bgImg&&bgImgG){
    bgImgG.innerHTML='';
    const img=ce('image');img.setAttributeNS('http://www.w3.org/1999/xlink','href',proj.data.bgImg);
    sa(img,{x:S.OX,y:S.OY,width:S.WPx,height:S.HPx,opacity:proj.data.bgOp||0.3,preserveAspectRatio:'xMidYMid meet'});
    bgImgG.appendChild(img);S.bgImgData=proj.data.bgImg;S.bgOpacity=proj.data.bgOp||0.3;
  }else{S.bgImgData=null}
  S.currentProject=name;
  pushH();S.dirty=false;updProjIndicator();
  updScaleDisp();updAutoDims();updBgControls();
  toast('Proyecto "'+name+'" cargado','ok');
}
function deleteProject(name){
  let p=getProjects().filter(x=>x.name!==name);
  localStorage.setItem(PROJ_KEY,JSON.stringify(p));
  if(S.currentProject===name)S.currentProject=null;
}
function showProjectsModal(){
  const projects=getProjects(),box=$('projlist');box.innerHTML='';
  if(projects.length===0){
    box.innerHTML='<div style="text-align:center;color:var(--txt3);padding:20px;font-size:12px">No hay proyectos guardados.<br>Usa "Guardar" para crear uno.</div>';
  }else{
    projects.sort((a,b)=>new Date(b.date)-new Date(a.date));
    projects.forEach(p=>{
      const d=document.createElement('div');d.className='proj-item'+(p.name===S.currentProject?' active':'');
      const date=new Date(p.date).toLocaleDateString('es',{day:'numeric',month:'short',year:'numeric'});
      const time=new Date(p.date).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
      const dims=p.data?(p.data.wm||0).toFixed(1)+'x'+(p.data.hm||0).toFixed(1)+'m':'';
      d.innerHTML=`<div style="flex:1;min-width:0">
        <div class="proj-name">${p.name}</div>
        <div style="font-size:9px;color:var(--txt3);margin-top:1px">${date} ${time} &middot; ${dims}</div>
      </div>
      <button class="proj-dl" title="Descargar .json">&#8681;</button>
      <button class="proj-del" title="Eliminar">&times;</button>`;
      d.querySelector('.proj-name').addEventListener('click',()=>{loadProject(p.name);$('projmodal').classList.remove('vis')});
      d.querySelector('.proj-dl').addEventListener('click',e=>{
        e.stopPropagation();
        const payload={version:'1.0',name:p.name,date:p.date,data:p.data};
        const blob=new Blob([JSON.stringify(payload)],{type:'application/json'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);
        a.download=p.name.replace(/[^a-zA-Z0-9_\- ]/g,'')+'.arquiplan.json';a.click();
        toast('Descargado','ok');
      });
      d.querySelector('.proj-del').addEventListener('click',e=>{e.stopPropagation();if(confirm('Eliminar "'+p.name+'"?')){deleteProject(p.name);showProjectsModal()}});
      box.appendChild(d);
    });
  }
  $('projmodal').classList.add('vis');
}
function newProject(){
  $('projmodal').classList.remove('vis');
  showWizard();
}

// ═══════════════════════════════════════════════════════════════
// ALIGNMENT
// ═══════════════════════════════════════════════════════════════
function alignSel(dir){
  if(S.sels.length<2)return;
  const rects=S.sels.map(g=>({g,pos:gPos(g),...gRect(g)})).filter(r=>r.w);
  if(rects.length<2)return;
  switch(dir){
    case 'left':{const ref=Math.min(...rects.map(r=>r.x));rects.forEach(r=>{sPos(r.g,r.pos.x+(ref-r.x),r.pos.y)});break}
    case 'centerH':{const ref=rects.reduce((s,r)=>s+r.x+r.w/2,0)/rects.length;rects.forEach(r=>{sPos(r.g,r.pos.x+(ref-r.x-r.w/2),r.pos.y)});break}
    case 'right':{const ref=Math.max(...rects.map(r=>r.x+r.w));rects.forEach(r=>{sPos(r.g,r.pos.x+(ref-r.x-r.w),r.pos.y)});break}
    case 'top':{const ref=Math.min(...rects.map(r=>r.y));rects.forEach(r=>{sPos(r.g,r.pos.x,r.pos.y+(ref-r.y))});break}
    case 'centerV':{const ref=rects.reduce((s,r)=>s+r.y+r.h/2,0)/rects.length;rects.forEach(r=>{sPos(r.g,r.pos.x,r.pos.y+(ref-r.y-r.h/2))});break}
    case 'bottom':{const ref=Math.max(...rects.map(r=>r.y+r.h));rects.forEach(r=>{sPos(r.g,r.pos.x,r.pos.y+(ref-r.y-r.h))});break}
    case 'distH':{
      rects.sort((a,b)=>a.x-b.x);const tw=rects.reduce((s,r)=>s+r.w,0);
      const mn=rects[0].x,mx=rects[rects.length-1].x+rects[rects.length-1].w;
      const gap=(mx-mn-tw)/(rects.length-1);let cx2=mn;
      rects.forEach(r=>{sPos(r.g,r.pos.x+(cx2-r.x),r.pos.y);cx2+=r.w+gap});break}
    case 'distV':{
      rects.sort((a,b)=>a.y-b.y);const th=rects.reduce((s,r)=>s+r.h,0);
      const mn=rects[0].y,mx=rects[rects.length-1].y+rects[rects.length-1].h;
      const gap=(mx-mn-th)/(rects.length-1);let cy2=mn;
      rects.forEach(r=>{sPos(r.g,r.pos.x,r.pos.y+(cy2-r.y));cy2+=r.h+gap});break}
  }
  drawSelHandles();pushH();updAutoDims();toast('Alineado','ok');
}

// ═══════════════════════════════════════════════════════════════
// HELP SYSTEM
// ═══════════════════════════════════════════════════════════════
function showHelp(){$('helpmodal').classList.add('vis');localStorage.setItem('ap-help-seen','1')}
function togHelp(hdr){hdr.parentElement.classList.toggle('open')}
function checkFirstVisit(){if(!localStorage.getItem('ap-help-seen'))setTimeout(showHelp,800)}

// ═══════════════════════════════════════════════════════════════
// WIZARD - NEW PROJECT TEMPLATES
// ═══════════════════════════════════════════════════════════════
function showWizard(){$('wizW').value=S.WM;$('wizH').value=S.HM;$('wizmodal').classList.add('vis')}

function pickTemplate(id){
  $('wizmodal').classList.remove('vis');
  if(id==='3hab'){
    S.WM=8.5;S.HM=10.1;buildPlan();
    $('sw').value=S.WM;$('sh').value=S.HM;
    fit();pushH();updScaleDisp();updAutoDims();S.currentProject=null;S.dirty=true;updProjIndicator();
    toast('Plantilla "Mi Apartamento" creada','ok');return;
  }
  buildFromTemplate(id);
}

function buildCustom(){
  const wm=+$('wizW').value,hm=+$('wizH').value;
  const name=$('wizName').value.trim()||'Mi plano';
  if(!wm||!hm||wm<2||wm>30||hm<2||hm>30){toast('Dimensiones: entre 2m y 30m','w');return}
  $('wizmodal').classList.remove('vis');
  buildFromTemplate('custom',wm,hm);
  S.currentProject=name;S.dirty=true;updProjIndicator();
}

function buildFromTemplate(id,cwm,chm){
  const TPLS={
    estudio:{wm:5.8,hm:6.0,title:'Estudio - ~35 m\u00B2',
      rooms:[
        {x:0,y:0,w:3.8,h:6.0,f:'#f5f2ed',n:'Sala / Dormitorio'},
        {x:3.8,y:0,w:2.0,h:3.0,f:'#f5edec',n:'Cocina',tc:'#8a3a3a'},
        {x:3.8,y:3.0,w:2.0,h:2.0,f:'#eaf2f5',n:'Bano',tc:'#3a6b8a'},
        {x:3.8,y:5.0,w:2.0,h:1.0,f:'#edf5ef',n:'Lavadero',tc:'#3a7a5a'}
      ],
      wins:[{x:0.5,y:0,w:1.2,hz:true},{x:2.3,y:0,w:0.8,hz:true}],
      doors:[{x:3.75,y:3.5,w:0.7,hz:false}],
      ent:{x:1.5,y:5.95,w:0.8,hz:true}
    },
    '1hab':{wm:7.0,hm:7.2,title:'1 Habitacion - ~50 m\u00B2',
      rooms:[
        {x:0,y:0,w:3.0,h:3.5,f:'#f2f0eb',n:'Dormitorio'},
        {x:3.0,y:0,w:4.0,h:4.5,f:'#f5f3ec',n:'Sala - Comedor',tc:'#7a6830'},
        {x:0,y:3.5,w:1.8,h:1.5,f:'#eaf2f5',n:'Bano',tc:'#3a6b8a'},
        {x:1.8,y:3.5,w:1.2,h:3.7,f:'#f7f6f3',n:'Pasillo',tc:'#999'},
        {x:3.0,y:4.5,w:4.0,h:2.7,f:'#f5edec',n:'Cocina',tc:'#8a3a3a'}
      ],
      wins:[{x:0.5,y:0,w:1.0,hz:true},{x:4.0,y:0,w:1.5,hz:true}],
      doors:[{x:2.95,y:0.8,w:0.8,hz:false},{x:0.5,y:3.45,w:0.7,hz:true}],
      ent:{x:3.5,y:7.15,w:0.9,hz:true}
    },
    '2hab':{wm:8.0,hm:8.8,title:'2 Habitaciones - ~70 m\u00B2',
      rooms:[
        {x:0,y:0,w:3.5,h:3.5,f:'#f2f0eb',n:'Habitacion Principal'},
        {x:3.5,y:0,w:4.5,h:3.5,f:'#f5f2ed',n:'Habitacion 2'},
        {x:0,y:3.5,w:4.5,h:5.3,f:'#f5f3ec',n:'Sala - Comedor',tc:'#7a6830'},
        {x:4.5,y:3.5,w:3.5,h:2.0,f:'#eaf2f5',n:'Bano',tc:'#3a6b8a'},
        {x:4.5,y:5.5,w:3.5,h:3.3,f:'#f5edec',n:'Cocina',tc:'#8a3a3a'}
      ],
      wins:[{x:0.5,y:0,w:1.2,hz:true},{x:5.0,y:0,w:1.2,hz:true},{x:0,y:5.0,w:1.5,hz:false}],
      doors:[{x:3.45,y:0.8,w:0.8,hz:false},{x:4.45,y:4.0,w:0.7,hz:false},{x:2.0,y:3.45,w:0.8,hz:true}],
      ent:{x:3.5,y:8.75,w:0.9,hz:true}
    },
    casa:{wm:10.0,hm:10.0,title:'Casa Pequena - ~100 m\u00B2',
      rooms:[
        {x:0,y:0,w:3.3,h:3.5,f:'#f2f0eb',n:'Habitacion 1'},
        {x:3.3,y:0,w:3.4,h:3.5,f:'#f5f2ed',n:'Habitacion 2'},
        {x:6.7,y:0,w:3.3,h:3.5,f:'#f3eef5',n:'Habitacion 3'},
        {x:0,y:3.5,w:2.5,h:2.0,f:'#eaf2f5',n:'Bano 1',tc:'#3a6b8a'},
        {x:2.5,y:3.5,w:2.5,h:2.0,f:'#eaf2f5',n:'Bano 2',tc:'#3a6b8a'},
        {x:5.0,y:3.5,w:5.0,h:2.0,f:'#f7f6f3',n:'Pasillo',tc:'#999'},
        {x:0,y:5.5,w:5.5,h:4.5,f:'#f5f3ec',n:'Sala - Comedor',tc:'#7a6830'},
        {x:5.5,y:5.5,w:2.5,h:4.5,f:'#f5edec',n:'Cocina',tc:'#8a3a3a'},
        {x:8.0,y:5.5,w:2.0,h:4.5,f:'#edf5ef',n:'Patio',tc:'#3a7a5a'}
      ],
      wins:[{x:0.5,y:0,w:1.0,hz:true},{x:4.0,y:0,w:1.0,hz:true},{x:7.5,y:0,w:1.0,hz:true},{x:0,y:7.0,w:1.5,hz:false}],
      doors:[{x:3.25,y:0.8,w:0.8,hz:false},{x:6.65,y:0.8,w:0.8,hz:false},{x:1.0,y:3.45,w:0.7,hz:true},{x:3.5,y:3.45,w:0.7,hz:true}],
      ent:{x:4.5,y:9.95,w:1.0,hz:true}
    },
    vacio:{wm:cwm||S.WM,hm:chm||S.HM,
      title:(cwm||S.WM).toFixed(1)+'m x '+(chm||S.HM).toFixed(1)+'m',
      rooms:[],wins:[],doors:[],ent:null},
    custom:{wm:cwm||8.5,hm:chm||10.1,
      title:(cwm||8.5).toFixed(1)+'m x '+(chm||10.1).toFixed(1)+'m',
      rooms:[],wins:[],doors:[],ent:null}
  };
  const t=TPLS[id];if(!t)return;
  const wm=t.wm,hm=t.hm;
  S.WM=wm;S.HM=hm;
  buildPlan();blocksG.innerHTML='';
  calcGeometry(wm,hm);

  const mpx=v=>S.OX+(v/wm)*S.WPx;
  const mpy=v=>S.OY+(v/hm)*S.HPx;
  const pw=v=>(v/wm)*S.WPx;
  const ph=v=>(v/hm)*S.HPx;

  insertByLayer(mkLabel(400,45,t.title,22,'#2d3436'));
  const bnd=ce('g');bnd.setAttribute('class','wall-block');bnd.setAttribute('data-type','boundary');bnd.setAttribute('data-name','Perimetro');
  sPos(bnd,S.OX,S.OY);
  const br=ce('rect');sa(br,{x:0,y:0,width:S.WPx,height:S.HPx,fill:'none',stroke:'#2d2d2d','stroke-width':'8',filter:'url(#planShd)'});
  bnd.appendChild(br);insertByLayer(bnd);

  t.rooms.forEach(r=>{insertByLayer(mkRoom(mpx(r.x),mpy(r.y),pw(r.w),ph(r.h),r.f,r.n,r.s||null,r.tc||'#4a4a4a'))});

  (t.wins||[]).forEach(w=>{
    if(w.hz)insertByLayer(mkWindow(mpx(w.x),mpy(w.y)-4,pw(w.w),true));
    else insertByLayer(mkWindow(mpx(w.x)-4,mpy(w.y),ph(w.w),false));
  });
  (t.doors||[]).forEach(d=>{
    if(d.hz)insertByLayer(mkDoor(mpx(d.x),mpy(d.y),pw(d.w),true));
    else insertByLayer(mkDoor(mpx(d.x),mpy(d.y),ph(d.w),false));
  });
  if(t.ent){
    const e=t.ent;
    if(e.hz){
      insertByLayer(mkDoor(mpx(e.x),mpy(e.y)-5,pw(e.w),true));
      insertByLayer(mkLabel(mpx(e.x+e.w/2),mpy(e.y)+15,'ENTRADA',12,'#3a3a3a'));
    }else{
      insertByLayer(mkDoor(mpx(e.x)-5,mpy(e.y),ph(e.w),false));
      insertByLayer(mkLabel(mpx(e.x)+15,mpy(e.y+e.w/2),'ENTRADA',12,'#3a3a3a'));
    }
  }

  $('sw').value=S.WM;$('sh').value=S.HM;
  fit();pushH();updScaleDisp();updAutoDims();S.currentProject=null;S.dirty=true;updProjIndicator();
  toast('Plantilla creada','ok');
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
function init(){
  loadTheme();
  // Migrate legacy data
  const legacy=localStorage.getItem('plano-v4');
  if(legacy&&getProjects().length===0){
    try{
      const ld=JSON.parse(legacy);
      const entry={name:'Mi plano (migrado)',data:{blocks:ld.blocks,wm:ld.wm,hm:ld.hm,bgImg:ld.bgImg||null,bgOp:ld.bgOp||0.3},date:new Date().toISOString()};
      localStorage.setItem(PROJ_KEY,JSON.stringify([entry]));
      localStorage.removeItem('plano-v4');
    }catch{}
  }else if(legacy){
    localStorage.removeItem('plano-v4');
  }
  // Load last project or show wizard
  const projects=getProjects();
  if(projects.length>0){
    const latest=projects.sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
    buildPlan();
    loadProject(latest.name);
  }else{
    buildPlan();
  }
  setup();fit();if(S.hist.length===0)pushH();updScaleDisp();buildLib();buildColors();buildLayers();updAutoDims();updBgControls();
  S.dirty=false;updProjIndicator();
  setTimeout(drawRulers,100);
  window.addEventListener('resize',()=>{drawRulers()});
  checkFirstVisit();
  if(projects.length===0)setTimeout(showWizard,400);
}
init();
</script>
</body>
</html>
